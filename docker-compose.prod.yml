# Copyright (C) 2023-2025 Civic OS, L3C
# AGPL-3.0-or-later

# Production Docker Compose Configuration
# This file demonstrates how to deploy Civic OS using pre-built container images
# from GitHub Container Registry

services:
  # PostgreSQL Database with PostGIS
  postgres:
    image: postgis/postgis:17-3.5-alpine
    container_name: civic_os_postgres
    restart: unless-stopped
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # Mount init scripts for first-time setup
      - ./postgres:/civic-os-core:ro
      - ./init-scripts:/docker-entrypoint-initdb.d
    networks:
      - civic-os-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 10s
      retries: 5

  # Database Migrations (runs before PostgREST)
  # This init container applies Sqitch migrations to ensure schema is up-to-date
  migrations:
    image: ghcr.io/${GITHUB_ORG:-civic-os}/migrations:${VERSION:-latest}
    container_name: civic_os_migrations
    environment:
      PGRST_DB_URI: postgres://postgres:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      CIVIC_OS_VERIFY_FULL: ${CIVIC_OS_VERIFY_FULL:-false}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - civic-os-network
    restart: on-failure  # Retry if migration fails transiently

  # PostgREST API with automatic JWKS fetching
  postgrest:
    image: ghcr.io/${GITHUB_ORG:-civic-os}/postgrest:${VERSION:-latest}
    container_name: civic_os_postgrest
    restart: unless-stopped
    ports:
      - "${POSTGREST_PORT:-3000}:3000"
    environment:
      # Database connection
      PGRST_DB_URI: postgres://authenticator:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      PGRST_DB_SCHEMA: public,metadata
      PGRST_DB_ANON_ROLE: web_anon
      PGRST_DB_PRE_REQUEST: public.check_jwt

      # Keycloak configuration (for JWKS fetching)
      KEYCLOAK_URL: ${KEYCLOAK_URL}
      KEYCLOAK_REALM: ${KEYCLOAK_REALM}

      # JWT settings
      PGRST_JWT_SECRET: "@/etc/postgrest/jwt-secret.jwks"
      PGRST_JWT_AUD: account

      # API settings
      PGRST_OPENAPI_SERVER_PROXY_URI: ${POSTGREST_PUBLIC_URL:-http://localhost:3000}
      PGRST_LOG_LEVEL: ${POSTGREST_LOG_LEVEL:-info}
    depends_on:
      postgres:
        condition: service_healthy
      migrations:
        condition: service_completed_successfully
    networks:
      - civic-os-network

  # Consolidated Worker - S3 Signer, Thumbnail Worker, and Notification Worker (v0.11.0+)
  # Single service with shared connection pool for improved resource efficiency
  # Handles: presigned upload URLs, image/PDF thumbnails, email notifications
  consolidated-worker:
    image: ghcr.io/${GITHUB_ORG:-civic-os}/consolidated-worker:${VERSION:-latest}
    container_name: civic_os_consolidated_worker
    restart: unless-stopped
    environment:
      # Database Configuration (shared pool)
      DATABASE_URL: postgres://postgres:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      DB_MAX_CONNS: ${DB_MAX_CONNS:-4}
      DB_MIN_CONNS: ${DB_MIN_CONNS:-1}

      # S3 Configuration (for file storage and thumbnails)
      S3_ENDPOINT: ${S3_ENDPOINT:-}  # Leave empty for AWS S3, set for MinIO/S3-compatible
      S3_PUBLIC_ENDPOINT: ${S3_PUBLIC_ENDPOINT}
      S3_BUCKET: ${S3_BUCKET:-civic-os-files}
      S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID}
      S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY}
      S3_REGION: ${S3_REGION:-us-east-1}

      # Thumbnail Worker Configuration
      THUMBNAIL_MAX_WORKERS: ${THUMBNAIL_MAX_WORKERS:-5}

      # Notification Worker Configuration
      SITE_URL: ${SITE_URL}
      NOTIFICATION_TIMEZONE: ${NOTIFICATION_TIMEZONE:-UTC}
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USERNAME: ${SMTP_USERNAME}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      SMTP_FROM: ${SMTP_FROM}
      SKIP_TEST_EMAILS: ${SKIP_TEST_EMAILS:-true}  # Prevent sending to @example.com in production
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - civic-os-network

  # Payment Worker - Stripe payment processing via River queue (v0.13.0+)
  # OPTIONAL: Only deploy if using payment features. Uncomment and configure Stripe credentials.
  # payment-worker:
  #   image: ghcr.io/${GITHUB_ORG:-civic-os}/payment-worker:${VERSION:-latest}
  #   container_name: civic_os_payment_worker
  #   restart: unless-stopped
  #   ports:
  #     - "${PAYMENT_WEBHOOK_PORT:-8081}:8080"  # Stripe webhook endpoint
  #   environment:
  #     # Database Configuration
  #     DATABASE_URL: postgres://postgres:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
  #     DB_MAX_CONNS: ${PAYMENT_WORKER_DB_MAX_CONNS:-4}
  #     DB_MIN_CONNS: ${PAYMENT_WORKER_DB_MIN_CONNS:-1}
  #
  #     # Stripe Configuration (REQUIRED)
  #     # Get keys from: https://dashboard.stripe.com/apikeys
  #     STRIPE_API_KEY: ${STRIPE_API_KEY}
  #     STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET}
  #
  #     # Payment Configuration
  #     PAYMENT_CURRENCY: ${PAYMENT_CURRENCY:-USD}
  #     RIVER_WORKER_COUNT: ${PAYMENT_WORKER_COUNT:-1}
  #     WEBHOOK_PORT: "8080"
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #   networks:
  #     - civic-os-network

  # Angular Frontend
  frontend:
    image: ghcr.io/${GITHUB_ORG:-civic-os}/frontend:${VERSION:-latest}
    container_name: civic_os_frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-80}:80"
    environment:
      # PostgREST connection (frontend â†’ postgrest)
      POSTGREST_URL: ${FRONTEND_POSTGREST_URL:-http://localhost:3000/}

      # Swagger UI connection (for API documentation link in About modal)
      SWAGGER_URL: ${SWAGGER_URL:-http://localhost:8080}

      # Keycloak configuration
      KEYCLOAK_URL: ${KEYCLOAK_URL}
      KEYCLOAK_REALM: ${KEYCLOAK_REALM}
      KEYCLOAK_CLIENT_ID: ${KEYCLOAK_CLIENT_ID}

      # Map configuration (optional overrides)
      MAP_TILE_URL: ${MAP_TILE_URL:-https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png}
      MAP_ATTRIBUTION: ${MAP_ATTRIBUTION:-&copy; <a href='https://www.openstreetmap.org/copyright'>OpenStreetMap</a> contributors}
      MAP_DEFAULT_LAT: ${MAP_DEFAULT_LAT:-43.0125}
      MAP_DEFAULT_LNG: ${MAP_DEFAULT_LNG:--83.6875}
      MAP_DEFAULT_ZOOM: ${MAP_DEFAULT_ZOOM:-13}

      # S3 configuration (for file storage)
      S3_ENDPOINT: ${S3_PUBLIC_ENDPOINT}
      S3_BUCKET: ${S3_BUCKET:-civic-os-files}

      # Analytics configuration (optional)
      MATOMO_URL: ${MATOMO_URL:-}
      MATOMO_SITE_ID: ${MATOMO_SITE_ID:-}
      MATOMO_ENABLED: ${MATOMO_ENABLED:-true}
    depends_on:
      - postgrest
    networks:
      - civic-os-network

volumes:
  postgres_data:

networks:
  civic-os-network:
    driver: bridge
