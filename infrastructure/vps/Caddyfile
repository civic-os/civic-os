# Caddyfile for Civic OS VPS Deployment
# Subdomain-based routing with automatic HTTPS via Let's Encrypt
#
# Required environment variable:
#   APP_DOMAIN - e.g., "demo.civic-os.app"
#
# This creates:
#   https://{APP_DOMAIN}       -> Frontend
#   https://api.{APP_DOMAIN}   -> PostgREST API
#   https://docs.{APP_DOMAIN}  -> Swagger UI

# Global options
{
	email dkurin@civic-os.org
}

# Main application — path-based routing + frontend
# When VANITY_DOMAIN is set (and differs from APP_DOMAIN), browser traffic
# redirects to the vanity domain. API/docs paths always served directly.
{$APP_DOMAIN} {
	handle_path /_/api/* {
		reverse_proxy postgrest:3000
	}

	redir /_/docs /_/docs/ 308
	handle_path /_/docs/* {
		reverse_proxy swagger-ui:8080
	}

	# Redirect browser traffic to vanity domain (if configured)
	@has_vanity expression `"{$VANITY_DOMAIN:}" != "" && "{$VANITY_DOMAIN:}" != "{$APP_DOMAIN}"`
	handle @has_vanity {
		redir https://{$VANITY_DOMAIN:}{uri} permanent
	}

	# Default: serve frontend directly
	handle {
		reverse_proxy frontend:80
	}
}

# API - PostgREST + Stripe webhooks
api.{$APP_DOMAIN} {
	# Stripe webhook endpoint (if payment-worker is running)
	# Stripe requires this to be publicly accessible
	handle /webhooks/stripe {
		reverse_proxy payment-worker:8080
	}

	# All other API requests go to PostgREST
	handle {
		reverse_proxy postgrest:3000
	}
}

# Documentation - Swagger UI
docs.{$APP_DOMAIN} {
	reverse_proxy swagger-ui:8080
}

# Per-instance config (vanity domain redirects, etc.)
# Files in conf.d/*.caddy are optional — glob is a no-op when empty
import /etc/caddy/conf.d/*.caddy
