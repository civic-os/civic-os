<div class="modal-box-content">
  <form [formGroup]="templateForm" (ngSubmit)="onSubmit()">
    <!-- Metadata Fields Row (spread across top) -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <!-- Template Name -->
      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Template Name *</span>
        </label>
        <input
          type="text"
          formControlName="name"
          class="input input-bordered input-sm"
          placeholder="e.g., issue_created"
          [class.input-error]="templateForm.get('name')?.invalid && templateForm.get('name')?.touched" />
        @if (templateForm.get('name')?.invalid && templateForm.get('name')?.touched) {
          <label class="label">
            <span class="label-text-alt text-error">Required</span>
          </label>
        }
      </div>

      <!-- Description -->
      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Description</span>
        </label>
        <input
          type="text"
          formControlName="description"
          class="input input-bordered input-sm"
          placeholder="Brief description" />
      </div>

      <!-- Entity Type -->
      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Entity Type</span>
        </label>
        @if (entities$ | async; as entities) {
          <select formControlName="entity_type" class="select select-bordered select-sm">
            <option value="">-- Select --</option>
            @for (entity of entities; track entity.table_name) {
              <option [value]="entity.table_name">{{ entity.display_name || entity.table_name }}</option>
            }
          </select>
        } @else {
          <select class="select select-bordered select-sm" disabled>
            <option>Loading...</option>
          </select>
        }
      </div>

      <!-- Sample Data Indicator -->
      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Sample Data</span>
        </label>
        <div class="flex items-center gap-2 h-10">
          @if (loadingSampleData()) {
            <span class="loading loading-spinner loading-xs"></span>
            <span class="text-sm text-base-content/60">Loading...</span>
          } @else if (templateForm.get('entity_type')?.value) {
            <button type="button" class="btn btn-xs btn-ghost" (click)="toggleSampleData()">
              @if (showSampleData()) {
                <span class="text-sm">Hide Data ▲</span>
              } @else {
                <span class="text-sm text-success">✓ Loaded - View ▼</span>
              }
            </button>
          } @else {
            <span class="text-sm text-base-content/60">Select entity type</span>
          }
        </div>
      </div>

      <!-- Collapsible Sample Data Editor (spans 2 columns, full width on mobile) -->
      @if (showSampleData() && templateForm.get('entity_type')?.value) {
        <div class="form-control col-span-full lg:col-span-2">
          <label class="label">
            <span class="label-text font-semibold">Sample Entity Data (JSON)</span>
            <span class="label-text-alt">Edit to customize preview data</span>
          </label>
          <textarea
            [(ngModel)]="sampleData"
            [ngModelOptions]="{standalone: true}"
            class="textarea textarea-bordered h-32 font-mono text-sm w-full"
            placeholder='{"display_name": "Test Issue", "severity": 5}'></textarea>
        </div>
      }
    </div>

    <!-- Template Tabs -->
    <div class="form-control">
      <!-- DaisyUI Tabs -->
      <div role="tablist" class="tabs tabs-bordered">
        <a
          role="tab"
          class="tab"
          [class.tab-active]="activeTab() === 'subject'"
          (click)="setActiveTab('subject')">
          Subject
          @if (isValidating('subject')) {
            <span class="loading loading-spinner loading-xs ml-2"></span>
          }
          @if (!isValidating('subject') && getValidationResult('subject')?.valid) {
            <span class="text-success ml-2">✓</span>
          }
        </a>
        <a
          role="tab"
          class="tab"
          [class.tab-active]="activeTab() === 'html'"
          (click)="setActiveTab('html')">
          HTML
          @if (isValidating('html')) {
            <span class="loading loading-spinner loading-xs ml-2"></span>
          }
          @if (!isValidating('html') && getValidationResult('html')?.valid) {
            <span class="text-success ml-2">✓</span>
          }
        </a>
        <a
          role="tab"
          class="tab"
          [class.tab-active]="activeTab() === 'text'"
          (click)="setActiveTab('text')">
          Text
          @if (isValidating('text')) {
            <span class="loading loading-spinner loading-xs ml-2"></span>
          }
          @if (!isValidating('text') && getValidationResult('text')?.valid) {
            <span class="text-success ml-2">✓</span>
          }
        </a>
        <a
          role="tab"
          class="tab"
          [class.tab-active]="activeTab() === 'sms'"
          (click)="setActiveTab('sms')">
          SMS (Optional)
          @if (isValidating('sms')) {
            <span class="loading loading-spinner loading-xs ml-2"></span>
          }
          @if (!isValidating('sms') && getValidationResult('sms')?.valid) {
            <span class="text-success ml-2">✓</span>
          }
        </a>
      </div>

      <!-- Tab Content -->
      <div class="mt-4">
        <!-- Subject Template Tab -->
        @if (activeTab() === 'subject') {
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <!-- Editor Column -->
            <div>
              <input
                type="text"
                formControlName="subject_template"
                class="input input-bordered w-full font-mono text-sm"
                [attr.placeholder]="subjectPlaceholder"
                [class.input-error]="templateForm.get('subject_template')?.invalid && templateForm.get('subject_template')?.touched" />
              @if (getValidationResult('subject')?.error_message) {
                <div class="alert alert-error mt-2 text-sm">
                  <span>{{ getValidationResult('subject')?.error_message }}</span>
                </div>
              }
              @if (templateForm.get('subject_template')?.invalid && templateForm.get('subject_template')?.touched) {
                <label class="label">
                  <span class="label-text-alt text-error">Subject template is required</span>
                </label>
              }
              <button
                type="button"
                class="btn btn-secondary btn-sm mt-3 w-full"
                (click)="previewSingleTemplate('subject')"
                [disabled]="previewing() || !templateForm.get('subject_template')?.value">
                @if (previewing()) {
                  <span class="loading loading-spinner loading-xs"></span>
                }
                Preview Subject
              </button>
            </div>
            <!-- Preview Column -->
            <div class="bg-base-200 p-4 rounded-lg">
              <h5 class="font-semibold text-sm mb-2">Preview:</h5>
              @if (getPreviewResult('subject')) {
                <div class="bg-base-100 p-3 rounded border border-base-300">
                  {{ getPreviewResult('subject') }}
                </div>
              } @else {
                <div class="text-base-content/60 text-sm text-center py-8">
                  Click "Preview Subject" to render with sample data
                </div>
              }
            </div>
          </div>
        }

        <!-- HTML Template Tab -->
        @if (activeTab() === 'html') {
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <!-- Editor Column -->
            <div>
              <textarea
                formControlName="html_template"
                class="textarea textarea-bordered w-full h-64 font-mono text-sm"
                [attr.placeholder]="htmlPlaceholder"
                [class.textarea-error]="templateForm.get('html_template')?.invalid && templateForm.get('html_template')?.touched"></textarea>
              @if (getValidationResult('html')?.error_message) {
                <div class="alert alert-error mt-2 text-sm">
                  <span>{{ getValidationResult('html')?.error_message }}</span>
                </div>
              }
              @if (templateForm.get('html_template')?.invalid && templateForm.get('html_template')?.touched) {
                <label class="label">
                  <span class="label-text-alt text-error">HTML template is required</span>
                </label>
              }
              <button
                type="button"
                class="btn btn-secondary btn-sm mt-3 w-full"
                (click)="previewSingleTemplate('html')"
                [disabled]="previewing() || !templateForm.get('html_template')?.value">
                @if (previewing()) {
                  <span class="loading loading-spinner loading-xs"></span>
                }
                Preview HTML
              </button>
            </div>
            <!-- Preview Column -->
            <div class="bg-base-200 p-4 rounded-lg">
              <h5 class="font-semibold text-sm mb-2">Preview:</h5>
              @if (getSafeHtmlPreview()) {
                <div
                  [innerHTML]="getSafeHtmlPreview()"
                  class="w-full h-96 border border-base-300 rounded bg-white overflow-auto"></div>
              } @else {
                <div class="text-base-content/60 text-sm text-center py-8">
                  Click "Preview HTML" to render with sample data
                </div>
              }
            </div>
          </div>
        }

        <!-- Text Template Tab -->
        @if (activeTab() === 'text') {
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <!-- Editor Column -->
            <div>
              <textarea
                formControlName="text_template"
                class="textarea textarea-bordered w-full h-64 font-mono text-sm"
                [attr.placeholder]="textPlaceholder"
                [class.textarea-error]="templateForm.get('text_template')?.invalid && templateForm.get('text_template')?.touched"></textarea>
              @if (getValidationResult('text')?.error_message) {
                <div class="alert alert-error mt-2 text-sm">
                  <span>{{ getValidationResult('text')?.error_message }}</span>
                </div>
              }
              @if (templateForm.get('text_template')?.invalid && templateForm.get('text_template')?.touched) {
                <label class="label">
                  <span class="label-text-alt text-error">Text template is required</span>
                </label>
              }
              <button
                type="button"
                class="btn btn-secondary btn-sm mt-3 w-full"
                (click)="previewSingleTemplate('text')"
                [disabled]="previewing() || !templateForm.get('text_template')?.value">
                @if (previewing()) {
                  <span class="loading loading-spinner loading-xs"></span>
                }
                Preview Text
              </button>
            </div>
            <!-- Preview Column -->
            <div class="bg-base-200 p-4 rounded-lg">
              <h5 class="font-semibold text-sm mb-2">Preview:</h5>
              @if (getPreviewResult('text')) {
                <pre class="bg-base-100 p-3 rounded border border-base-300 text-xs whitespace-pre-wrap overflow-x-auto">{{ getPreviewResult('text') }}</pre>
              } @else {
                <div class="text-base-content/60 text-sm text-center py-8">
                  Click "Preview Text" to render with sample data
                </div>
              }
            </div>
          </div>
        }

        <!-- SMS Template Tab -->
        @if (activeTab() === 'sms') {
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <!-- Editor Column -->
            <div>
              <textarea
                formControlName="sms_template"
                class="textarea textarea-bordered w-full h-32 font-mono text-sm"
                [attr.placeholder]="smsPlaceholder"></textarea>
              @if (getValidationResult('sms')?.error_message) {
                <div class="alert alert-error mt-2 text-sm">
                  <span>{{ getValidationResult('sms')?.error_message }}</span>
                </div>
              }
              <label class="label">
                <span class="label-text-alt">160 character limit (Phase 2)</span>
              </label>
              <button
                type="button"
                class="btn btn-secondary btn-sm mt-3 w-full"
                (click)="previewSingleTemplate('sms')"
                [disabled]="previewing() || !templateForm.get('sms_template')?.value">
                @if (previewing()) {
                  <span class="loading loading-spinner loading-xs"></span>
                }
                Preview SMS
              </button>
            </div>
            <!-- Preview Column -->
            <div class="bg-base-200 p-4 rounded-lg">
              <h5 class="font-semibold text-sm mb-2">Preview:</h5>
              @if (getPreviewResult('sms')) {
                <div class="bg-base-100 p-3 rounded border border-base-300 text-sm">
                  {{ getPreviewResult('sms') }}
                </div>
              } @else {
                <div class="text-base-content/60 text-sm text-center py-8">
                  Click "Preview SMS" to render with sample data
                </div>
              }
            </div>
          </div>
        }
      </div>

      <!-- Template Syntax Help -->
      <div class="alert alert-info text-xs mt-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-4 w-4" fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <div>
          <div class="font-semibold mb-1">Template Syntax:</div>
          <div><code>{{ syntaxExample1 }}</code> - Access entity data</div>
          <div><code>{{ syntaxExample2 }}</code> - Site URL</div>
          <div><code>{{ syntaxExample3 }}</code> - Conditionals</div>
        </div>
      </div>
    </div>

    <!-- Error Alert -->
    @if (saveError()) {
      <div class="alert alert-error mt-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span>{{ saveError() }}</span>
      </div>
    }

    <!-- Modal Actions -->
    <div class="modal-action">
      <button type="button" class="btn btn-ghost" (click)="onCancel()" [disabled]="saving()">
        Cancel
      </button>
      <button
        type="submit"
        class="btn btn-primary"
        [disabled]="saving() || templateForm.invalid">
        @if (saving()) {
          <span class="loading loading-spinner loading-sm"></span>
        }
        {{ template ? 'Update Template' : 'Create Template' }}
      </button>
    </div>
  </form>
</div>
