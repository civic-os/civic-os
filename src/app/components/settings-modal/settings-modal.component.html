<cos-modal [isOpen]="showModal()" (closed)="close()" size="sm">
  <h3 class="font-bold text-lg mb-4">Settings</h3>

  <!-- Privacy Section -->
  @if (analyticsConfigured) {
    <div class="py-4">
      <h4 class="font-semibold mb-3">Privacy</h4>
      <label class="flex items-start cursor-pointer gap-3">
        <input
          type="checkbox"
          class="checkbox flex-shrink-0 mt-0.5"
          [(ngModel)]="analyticsEnabled"
          (change)="onAnalyticsToggle()"
        />
        <span>Share anonymous usage data to help improve Civic OS</span>
      </label>
      <p class="text-xs opacity-70 mt-1 ml-9">
        We collect page views and feature usage statistics. No personal information or data content is tracked.
        You can change this preference at any time.
      </p>
    </div>
  }

  <!-- Notifications Section -->
  <div class="py-4">
    <h4 class="font-semibold mb-3">Notifications</h4>

    @if (preferencesLoading()) {
      <div class="text-sm opacity-70">Loading preferences...</div>
    } @else {
      <!-- Email Notifications -->
      @if (emailPreference(); as email) {
        <div class="mb-4">
          <label class="flex items-start cursor-pointer gap-3">
            <input
              type="checkbox"
              class="checkbox flex-shrink-0 mt-0.5"
              [checked]="email.enabled"
              (change)="onEmailToggle($any($event.target).checked)"
            />
            <span>Email notifications</span>
          </label>
          <p class="text-xs opacity-70 mt-1 ml-9">
            Send notifications to: <strong>{{ email.email_address }}</strong>
          </p>
        </div>
      }

      <!-- SMS Notifications -->
      @if (smsPreference(); as sms) {
        <div class="mb-4">
          <label class="flex items-start cursor-pointer gap-3">
            <input
              type="checkbox"
              class="checkbox flex-shrink-0 mt-0.5"
              [checked]="sms.enabled"
              (change)="onSmsToggle($any($event.target).checked)"
            />
            <span>SMS notifications</span>
          </label>
          <p class="text-xs opacity-70 mt-1 ml-9">
            Send notifications to: <strong>{{ sms.phone_number | slice:0:3 }}-{{ sms.phone_number | slice:3:6 }}-{{ sms.phone_number | slice:6:10 }}</strong>
          </p>
        </div>
      }

      @if (!emailPreference() && !smsPreference()) {
        <p class="text-sm opacity-70">No notification preferences found. They will be created on your next login.</p>
      }
    }
  </div>

  <!-- Admin Section: Role Impersonation (only for real admins) -->
  @if (auth.isRealAdmin()) {
    <div class="py-4 border-t border-base-300">
      <h4 class="font-semibold mb-3">Admin: Role Impersonation</h4>
      <p class="text-xs opacity-70 mb-3">
        Test the app as if you only have specific roles. Your real identity is preserved.
      </p>

      @if (impersonation.isActive()) {
        <!-- Currently impersonating -->
        <div class="p-3 rounded-lg bg-warning/10 border border-warning mb-3">
          <div class="flex items-center gap-2 text-warning mb-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
            </svg>
            <span class="font-medium">Impersonation Active</span>
          </div>
          <p class="text-sm mb-2">
            Currently viewing as: <strong>{{ impersonation.impersonatedRoles().join(', ') }}</strong>
          </p>
          <button
            class="btn btn-warning btn-sm"
            (click)="stopImpersonation()"
            [disabled]="impersonationLoading()"
          >
            @if (impersonationLoading()) {
              <span class="loading loading-spinner loading-xs"></span>
            }
            Stop Impersonation
          </button>
        </div>
      } @else {
        <!-- Role selection -->
        <div class="mb-3">
          <p class="text-sm mb-2">Select roles to impersonate:</p>
          <div class="flex flex-wrap gap-2">
            @for (role of availableRoles(); track role.id) {
              <label class="cursor-pointer">
                <input
                  type="checkbox"
                  class="checkbox checkbox-sm hidden"
                  [checked]="isRoleSelected(role.display_name)"
                  (change)="toggleRole(role.display_name)"
                />
                <span
                  class="badge badge-lg cursor-pointer transition-colors"
                  [class.badge-primary]="isRoleSelected(role.display_name)"
                  [class.badge-outline]="!isRoleSelected(role.display_name)"
                >
                  {{ role.display_name }}
                </span>
              </label>
            }
          </div>
        </div>

        <button
          class="btn btn-primary btn-sm"
          (click)="startImpersonation()"
          [disabled]="selectedRoles().length === 0 || impersonationLoading()"
        >
          @if (impersonationLoading()) {
            <span class="loading loading-spinner loading-xs"></span>
          }
          Start Impersonation
        </button>
      }
    </div>
  }

  <div class="cos-modal-action">
    <button class="btn" (click)="close()">Close</button>
  </div>
</cos-modal>
