<!-- Skip Navigation Link -->
<a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-0 focus:left-0 focus:z-50 focus:p-4 focus:bg-primary focus:text-primary-content">
  Skip to main content
</a>

<div class="drawer">
  <input id="main-drawer" [(ngModel)]="drawerOpen" type="checkbox" class="drawer-toggle" />
  <div class="drawer-content">
    <div class="navbar bg-base-300">
      <div class="flex-none">
        <label for="main-drawer" class="btn btn-square btn-ghost drawer-button" aria-label="Open navigation menu">
          <span class="material-symbols-outlined" aria-hidden="true">menu</span>
        </label>
      </div>
      <div class="flex-1">
        <a class="btn btn-ghost text-xl">Civic OS</a>
      </div>
      <div class="flex-none">
        <!-- Dashboard Selector (only shown on dashboard pages) -->
        @if (isDashboardRoute()) {
          <app-dashboard-selector></app-dashboard-selector>
        }

        <!-- Theme Selector -->
        <div class="dropdown">
          <div tabindex="0" role="button" class="btn m-1">
            Theme
            <svg width="12px" height="12px" class="h-2 w-2 fill-current opacity-60 inline-block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2048 2048"><path d="M1799 349l242 241-1017 1017L7 590l242-241 775 775 775-775z"></path></svg>
          </div>
          <ul tabindex="0" class="dropdown-content z-[1] p-2 shadow-2xl bg-base-300 rounded-box w-52">
            <li><input type="radio" name="theme-dropdown" class="theme-controller btn btn-sm btn-block btn-ghost justify-start" aria-label="Corporate" value="corporate" [checked]="themeService.theme() === 'corporate'" (change)="themeService.setTheme('corporate')"/></li>
            <li><input type="radio" name="theme-dropdown" class="theme-controller btn btn-sm btn-block btn-ghost justify-start" aria-label="Light" value="light" [checked]="themeService.theme() === 'light'" (change)="themeService.setTheme('light')"/></li>
            <li><input type="radio" name="theme-dropdown" class="theme-controller btn btn-sm btn-block btn-ghost justify-start" aria-label="Dark" value="dark" [checked]="themeService.theme() === 'dark'" (change)="themeService.setTheme('dark')"/></li>
            <li><input type="radio" name="theme-dropdown" class="theme-controller btn btn-sm btn-block btn-ghost justify-start" aria-label="Nord" value="nord" [checked]="themeService.theme() === 'nord'" (change)="themeService.setTheme('nord')"/></li>
            <li><input type="radio" name="theme-dropdown" class="theme-controller btn btn-sm btn-block btn-ghost justify-start" aria-label="Emerald" value="emerald" [checked]="themeService.theme() === 'emerald'" (change)="themeService.setTheme('emerald')"/></li>
          </ul>
        </div>
        <!-- Impersonation Button (shown when active) -->
        @if (impersonation.isActive()) {
          <button class="btn btn-warning m-1" (click)="openSettings()" title="Click to manage impersonation">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
            </svg>
            Impersonating
          </button>
        }

        <details id="profile-dropdown" class="dropdown dropdown-end">
          <summary class="btn m-1" [class.btn-ghost]="!impersonation.isActive()" [class.btn-warning]="impersonation.isActive()" aria-label="User account menu">
            @if (this.auth.authenticated()) {
              @if (impersonation.isActive()) {
                <!-- Warning icon when impersonating -->
                <span class="material-symbols-outlined" aria-hidden="true">shield_person</span>
              } @else {
                <span class="material-symbols-outlined" aria-hidden="true">account_circle</span>
              }
            } @else {
              <span class="material-symbols-outlined" aria-hidden="true">person</span>
            }
          </summary>
          <ul class="menu dropdown-content bg-base-100 rounded-box z-[1] w-52 p-2 shadow">
            @if (this.auth.authenticated()) {
              @if (impersonation.isActive()) {
                <!-- Impersonation info at top of menu -->
                <li class="menu-disabled">
                  <span class="text-warning text-xs">
                    Viewing as: {{ impersonation.impersonatedRoles().join(', ') }}
                  </span>
                </li>
                <li><a class="text-warning font-medium" (click)="stopImpersonation()">Stop Impersonation</a></li>
                <li class="border-t border-base-300 my-1"></li>
              }
              <li><a (click)="openSettings()">Preferences</a></li>
              <li><a [href]="getKeycloakAccountUrl()">Account Settings</a></li>
              <li><a (click)="this.auth.logout()">Logout</a></li>
            } @else {
              <li><a (click)="this.auth.login()">Log In</a></li>
            }
            <li class="border-t border-base-300 my-1"></li>
            <li><a (click)="openAbout()">About Civic OS</a></li>
          </ul>
        </details>
      </div>
    </div>
    <main id="main-content" class="container mx-auto px-0 sm:px-2 md:px-0">
      <router-outlet></router-outlet>
    </main>
  </div>
  <div class="drawer-side">
    <label for="main-drawer" aria-label="close sidebar" class="drawer-overlay"></label>
    @if (menuItems$ | async; as menuItems) {
      <div class="w-80 min-h-full bg-base-200 text-base-content flex flex-col">
        <div class="navbar bg-base-300">
          <div class="flex-none">
            <label for="main-drawer" class="btn btn-square btn-ghost" aria-label="Close navigation menu">
              <span class="material-symbols-outlined" aria-hidden="true">close</span>
            </label>
          </div>
        </div>
        <ul class="menu menu-md p-4 flex-1">
          <!-- Home -->
          <li (click)="navigateToHome()">
            <a [class.menu-active]="isRouteActive('/')"
               [class.font-bold]="isRouteActive('/')"
               [class.opacity-85]="!isRouteActive('/')">
              <span class="material-symbols-outlined" aria-hidden="true">home</span>
              Home
            </a>
          </li>

          <!-- Entity menu items -->
          <li class="mt-4">
            <span class="block px-4 py-2 text-base font-bold uppercase tracking-wide pointer-events-none">Data</span>
          </li>
          @for (entity of menuItems; track entity) {
            <li (click)="navigate(entity.table_name)">
              <a [class.menu-active]="isRouteActive('/view/' + entity.table_name)"
                 [class.font-bold]="isRouteActive('/view/' + entity.table_name)"
                 [class.opacity-85]="!isRouteActive('/view/' + entity.table_name)">
                {{ entity.display_name }}
              </a>
            </li>
          }

          <!-- About section -->
          <li class="mt-4">
            <span class="block px-4 py-2 text-base font-bold uppercase tracking-wide pointer-events-none">About</span>
          </li>
          <li (click)="navigateToSchemaEditor()">
            <a [class.menu-active]="isRouteActive('/schema-editor')"
               [class.font-bold]="isRouteActive('/schema-editor')"
               [class.opacity-85]="!isRouteActive('/schema-editor')">
              <span class="material-symbols-outlined" aria-hidden="true">account_tree</span>
              Database Schema
            </a>
          </li>
          <!-- Admin section (shown to admins OR users with feature permissions) -->
          @if (showAdminSection()) {
            <li class="mt-4">
              <span class="block px-4 py-2 text-base font-bold uppercase tracking-wide pointer-events-none">Admin</span>
            </li>
            <!-- Core admin items (admin-only) -->
            @if (auth.isAdmin()) {
              <li (click)="navigateToEntityManagement()">
                <a [class.menu-active]="isRouteActive('/entity-management')"
                   [class.font-bold]="isRouteActive('/entity-management')"
                   [class.opacity-85]="!isRouteActive('/entity-management')">
                  <span class="material-symbols-outlined" aria-hidden="true">dashboard_customize</span>
                  Entities
                </a>
              </li>
              <li (click)="navigateToPropertyManagement()">
                <a [class.menu-active]="isRouteActive('/property-management')"
                   [class.font-bold]="isRouteActive('/property-management')"
                   [class.opacity-85]="!isRouteActive('/property-management')">
                  <span class="material-symbols-outlined" aria-hidden="true">tune</span>
                  Properties
                </a>
              </li>
              <li (click)="navigateToPermissions()">
                <a [class.menu-active]="isRouteActive('/permissions')"
                   [class.font-bold]="isRouteActive('/permissions')"
                   [class.opacity-85]="!isRouteActive('/permissions')">
                  <span class="material-symbols-outlined" aria-hidden="true">lock</span>
                  Permissions
                </a>
              </li>
              <li (click)="navigateToNotificationTemplates()">
                <a [class.menu-active]="isRouteActive('/notifications/templates')"
                   [class.font-bold]="isRouteActive('/notifications/templates')"
                   [class.opacity-85]="!isRouteActive('/notifications/templates')">
                  <span class="material-symbols-outlined" aria-hidden="true">notifications</span>
                  Notifications
                </a>
              </li>
              <li (click)="navigateToSystemFunctions()">
                <a [class.menu-active]="isRouteActive('/system/functions')"
                   [class.font-bold]="isRouteActive('/system/functions')"
                   [class.opacity-85]="!isRouteActive('/system/functions')">
                  <span class="material-symbols-outlined" aria-hidden="true">functions</span>
                  Functions & RPCs
                </a>
              </li>
              <li (click)="navigateToSystemPolicies()">
                <a [class.menu-active]="isRouteActive('/system/policies')"
                   [class.font-bold]="isRouteActive('/system/policies')"
                   [class.opacity-85]="!isRouteActive('/system/policies')">
                  <span class="material-symbols-outlined" aria-hidden="true">shield</span>
                  Security Policies
                </a>
              </li>
            }
            <!-- User Management (shown to users with civic_os_users_private permissions) -->
            @if (hasUserManagementPermission()) {
              <li (click)="navigateToUserManagement()">
                <a [class.menu-active]="isRouteActive('/admin/users')"
                   [class.font-bold]="isRouteActive('/admin/users')"
                   [class.opacity-85]="!isRouteActive('/admin/users')">
                  <span class="material-symbols-outlined" aria-hidden="true">group</span>
                  Users
                </a>
              </li>
            }
            <!-- Feature-specific items (shown based on entity config + user permissions) -->
            @if (hasRecurringEntities() && hasRecurringSchedulePermission()) {
              <li (click)="navigateToRecurringSchedules()">
                <a [class.menu-active]="isRouteActive('/admin/recurring-schedules')"
                   [class.font-bold]="isRouteActive('/admin/recurring-schedules')"
                   [class.opacity-85]="!isRouteActive('/admin/recurring-schedules')">
                  <span class="material-symbols-outlined" aria-hidden="true">event_repeat</span>
                  Recurring Schedules
                </a>
              </li>
            }
            @if (hasPaymentEntities() && hasPaymentPermission()) {
              <li (click)="navigateToPaymentsAdmin()">
                <a [class.menu-active]="isRouteActive('/admin/payments')"
                   [class.font-bold]="isRouteActive('/admin/payments')"
                   [class.opacity-85]="!isRouteActive('/admin/payments')">
                  <span class="material-symbols-outlined" aria-hidden="true">payments</span>
                  Payments
                </a>
              </li>
            }
          }
        </ul>
      </div>
    }
  </div>
</div>

<!-- Settings Modal -->
<app-settings-modal
  [showModal]="showSettingsModal()"
  (closeModal)="showSettingsModal.set(false)"
/>

<!-- About Modal -->
<app-about-modal
  [showModal]="showAboutModal()"
  (closeModal)="showAboutModal.set(false)"
/>