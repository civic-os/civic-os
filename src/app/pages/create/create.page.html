<div class="prose">
  @if (entity$ | async; as entity) {
    @if (properties$ | async; as props) {
      <div class="flex items-center gap-4 mb-4">
        <button class="btn btn-ghost btn-circle" [routerLink]="'/view/' + entity.table_name" type="button">
          <span class="material-symbols-outlined">arrow_back</span>
        </button>
        <h1 class="mb-0">
          New {{ entity.display_name }}
          @if (entity.description) {
            <div class="tooltip tooltip-right inline-block" [attr.data-tip]="entity.description">
              <span class="material-symbols-outlined text-info cursor-help ml-2 text-xl align-middle">help_outline</span>
            </div>
          }
        </h1>
      </div>
      @if (createForm && entity.insert) {
        <form [formGroup]="createForm" (ngSubmit)="submitForm($event)">
          @if (showValidationError) {
            <div role="alert" class="alert alert-error mb-4">
              <span class="material-symbols-outlined">error</span>
              <span>Please fix the errors highlighted below before saving.</span>
            </div>
          }
          <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 2xl:grid-cols-8 gap-6">
            @if (createRenderables$ | async; as renderables) {
              @for (item of renderables; track item.itemType === 'static_text' ? 'st_' + item.id : item.column_name) {
                @if (isStaticText(item)) {
                  <div [class]="'col-span-full sm:col-span-' + Math.min(SchemaService.getRenderableColumnSpan(item), 3) + ' lg:col-span-' + Math.min(SchemaService.getRenderableColumnSpan(item), 6) + ' 2xl:col-span-' + SchemaService.getRenderableColumnSpan(item)">
                    <app-static-text [staticText]="item"></app-static-text>
                  </div>
                } @else if (isProperty(item)) {
                  <div [class]="'col-span-full sm:col-span-' + Math.min(SchemaService.getRenderableColumnSpan(item), 3) + ' lg:col-span-' + Math.min(SchemaService.getRenderableColumnSpan(item), 6) + ' 2xl:col-span-' + SchemaService.getRenderableColumnSpan(item)">
                    <app-edit-property [property]="item" [formGroup]="createForm"></app-edit-property>
                  </div>
                }
              }
            }
          </div>
          <div class="divider"></div>
          <button type="submit" class="btn btn-accent">
            <span class="material-symbols-outlined">save</span> Save
          </button>
        </form>
      } @else {
        <!-- Empty state when form is not available -->
        <div class="p-8">
          @if (!auth.authenticated()) {
            <app-empty-state
              icon="lock"
              title="Sign in to create records"
              message="Log in to access this feature."
              alertType="info"
              [showLoginButton]="true">
            </app-empty-state>
          } @else {
            <app-empty-state
              icon="block"
              title="Access denied"
              message="You don't have permission to create records of this type."
              alertType="error">
            </app-empty-state>
          }
        </div>
      }
    }
    <!-- Success Modal -->
    <cos-modal [isOpen]="showSuccessModal()" (closed)="closeSuccessModal()" size="sm">
      <h3 class="font-bold text-lg mb-4">
        <span class="material-symbols-outlined text-success align-middle mr-2">check_circle</span>
        Success
      </h3>
      <p class="mb-4">Record created successfully.</p>
      <div class="flex flex-col gap-2 w-full">
        <button class="btn btn-primary whitespace-normal h-auto min-h-12" (click)="navToDetail()">View created {{entity.display_name}}</button>
        <button class="btn whitespace-normal h-auto min-h-12" (click)="navToCreate(entity.table_name)">Create another {{entity.display_name}}</button>
        <button class="btn whitespace-normal h-auto min-h-12" (click)="navToList(entity.table_name)">Back to {{entity.display_name}} list</button>
      </div>
    </cos-modal>

    <!-- Error Modal -->
    <cos-modal [isOpen]="showErrorModal()" (closed)="closeErrorModal()" size="sm">
      <h3 class="font-bold text-lg mb-4">
        <span class="material-symbols-outlined text-error align-middle mr-2">error</span>
        Error
      </h3>
      @if (currentError(); as err) {
        <div class="collapse collapse-plus bg-base-200 mb-4">
          <input type="checkbox" />
          <div class="collapse-title font-medium">
            {{ err.humanMessage }}
          </div>
          <div class="collapse-content">
            <p>{{err.code ?? err.httpCode}}: {{err.message}}</p>
            @if (err.hint) {
              <p class="mt-2 text-sm opacity-70">{{err.hint}}</p>
            }
          </div>
        </div>
      }
      <div class="flex flex-col gap-2 w-full">
        <button class="btn whitespace-normal h-auto min-h-12" (click)="closeErrorModal()">Try again</button>
        <button class="btn whitespace-normal h-auto min-h-12" (click)="navToList(entity.table_name)">Back to {{entity.display_name}} list</button>
      </div>
    </cos-modal>
  }
</div>
