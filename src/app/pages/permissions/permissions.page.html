<div class="container mx-auto p-6">
  <h1 class="text-3xl font-bold mb-6">Permissions Management</h1>

  @if (successMessage()) {
    <div class="alert alert-success mb-4 relative">
      <button
        class="btn btn-ghost btn-sm absolute top-2 right-2"
        (click)="dismissSuccess()">
        ✕
      </button>
      <div class="flex flex-col gap-2 pr-8">
        <span class="font-semibold">{{ successMessage() }}</span>
        @if (newlyCreatedRoleName()) {
          <p class="text-sm">Role <strong>{{ newlyCreatedRoleName() }}</strong> will be synced to Keycloak automatically.</p>
        }
      </div>
    </div>
  }

  @if (error()) {
    <div class="alert alert-error mb-4">
      <span>{{ error() }}</span>
    </div>
  }

  @if (loading()) {
    <div class="flex justify-center items-center min-h-[400px]">
      <span class="loading loading-spinner loading-lg"></span>
    </div>
  }

  @if (!loading() && isAdmin() && !error()) {
    <div>
      <!-- Role Selector with New Role Button (applies to both tabs) -->
      <div class="flex items-end gap-4 mb-6">
        <div class="w-full max-w-xs">
          <label class="label" for="role-selector">
            <span class="font-semibold">Select Role</span>
          </label>
          <select
            id="role-selector"
            class="select select-bordered"
            [ngModel]="selectedRoleId()"
            (ngModelChange)="onRoleChange($event)">
            @for (role of roles(); track role) {
              <option [value]="role.id">
                {{ role.display_name }}
              </option>
            }
          </select>
        </div>
        <button
          class="btn btn-primary"
          (click)="openCreateRoleModal()">
          + New Role
        </button>
      </div>

      <!-- Tabs (DaisyUI 5 syntax) -->
      <div role="tablist" class="tabs tabs-lift tabs-lg mb-6">
        <button
          role="tab"
          class="tab"
          [class.tab-active]="activeTab() === 'tables'"
          (click)="switchTab('tables')">
          Table Permissions
        </button>
        <button
          role="tab"
          class="tab"
          [class.tab-active]="activeTab() === 'actions'"
          (click)="switchTab('actions')">
          Entity Actions
        </button>
        <button
          role="tab"
          class="tab"
          [class.tab-active]="activeTab() === 'delegation'"
          (click)="switchTab('delegation')">
          Role Delegation
        </button>
      </div>

      <!-- Table Permissions Tab -->
      @if (activeTab() === 'tables') {
        <div class="overflow-x-auto">
          <table class="table table-zebra">
            <thead>
              <tr>
                <th class="font-bold">Table</th>
                <th class="text-center font-bold">Create</th>
                <th class="text-center font-bold">Read</th>
                <th class="text-center font-bold">Update</th>
                <th class="text-center font-bold">Delete</th>
              </tr>
            </thead>
            <tbody>
              @for (row of permissionMatrix(); track row) {
                <tr>
                  <td class="font-semibold">{{ row.tableName }}</td>
                  <td class="text-center">
                    @if (isPermissionApplicable(row.tableName, 'create')) {
                      <input
                        type="checkbox"
                        class="checkbox checkbox-primary checkbox-sm"
                        [checked]="row.create"
                        (change)="togglePermission(row.tableName, 'create', row.create)" />
                    } @else {
                      <span class="text-base-content/30">—</span>
                    }
                  </td>
                  <td class="text-center">
                    @if (isPermissionApplicable(row.tableName, 'read')) {
                      <input
                        type="checkbox"
                        class="checkbox checkbox-primary checkbox-sm"
                        [checked]="row.read"
                        (change)="togglePermission(row.tableName, 'read', row.read)" />
                    } @else {
                      <span class="text-base-content/30">—</span>
                    }
                  </td>
                  <td class="text-center">
                    @if (isPermissionApplicable(row.tableName, 'update')) {
                      <input
                        type="checkbox"
                        class="checkbox checkbox-primary checkbox-sm"
                        [checked]="row.update"
                        (change)="togglePermission(row.tableName, 'update', row.update)" />
                    } @else {
                      <span class="text-base-content/30">—</span>
                    }
                  </td>
                  <td class="text-center">
                    @if (isPermissionApplicable(row.tableName, 'delete')) {
                      <input
                        type="checkbox"
                        class="checkbox checkbox-primary checkbox-sm"
                        [checked]="row.delete"
                        (change)="togglePermission(row.tableName, 'delete', row.delete)" />
                    } @else {
                      <span class="text-base-content/30">—</span>
                    }
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }

      <!-- Entity Actions Tab -->
      @if (activeTab() === 'actions') {
        @if (entityActionLoading()) {
          <div class="flex justify-center items-center min-h-[200px]">
            <span class="loading loading-spinner loading-lg"></span>
          </div>
        } @else if (entityActionPermissions().length === 0) {
          <div class="alert alert-info">
            <span class="material-symbols-outlined">info</span>
            <span>No entity actions have been configured yet. Entity actions are defined in the database via the <code>metadata.entity_actions</code> table.</span>
          </div>
        } @else {
          <div class="overflow-x-auto">
            <table class="table table-zebra">
              <thead>
                <tr>
                  <th class="font-bold">Entity</th>
                  <th class="font-bold">Action</th>
                  <th class="text-center font-bold">Can Execute</th>
                </tr>
              </thead>
              <tbody>
                @for (action of entityActionPermissions(); track action.id) {
                  <tr>
                    <td class="font-semibold">{{ action.table_name }}</td>
                    <td>
                      <div>{{ action.display_name }}</div>
                      @if (action.description) {
                        <div class="text-xs opacity-60">{{ action.description }}</div>
                      }
                    </td>
                    <td class="text-center">
                      <input
                        type="checkbox"
                        class="checkbox checkbox-primary checkbox-sm"
                        [checked]="action.has_permission"
                        (change)="toggleEntityActionPermission(action)" />
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      }

      <!-- Role Delegation Tab -->
      @if (activeTab() === 'delegation') {
        @if (delegationLoading()) {
          <div class="flex justify-center items-center min-h-[200px]">
            <span class="loading loading-spinner loading-lg"></span>
          </div>
        } @else {
          <div class="mb-4">
            <p class="text-base-content/60 text-sm">
              Configure which roles the selected role can assign or revoke from users.
            </p>
          </div>

          <div class="overflow-x-auto">
            <table class="table table-zebra">
              <thead>
                <tr>
                  <th class="font-bold">Role</th>
                  <th class="text-center font-bold">Can Manage</th>
                </tr>
              </thead>
              <tbody>
                @for (role of delegationRoles(); track role.id) {
                  <tr>
                    <td>
                      <div class="font-semibold">{{ role.display_name }}</div>
                      @if (role.description) {
                        <div class="text-xs opacity-60">{{ role.description }}</div>
                      }
                    </td>
                    <td class="text-center">
                      @if (role.id === selectedRoleId()) {
                        <span class="text-base-content/30">—</span>
                      } @else {
                        <input
                          type="checkbox"
                          class="checkbox checkbox-primary checkbox-sm"
                          [checked]="isDelegated(role.id)"
                          (change)="toggleDelegation(role.id)" />
                      }
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>

          <!-- Delete Role Button -->
          <div class="mt-6 pt-4 border-t border-base-300">
            <button
              class="btn btn-error btn-sm"
              (click)="openDeleteRoleModal()">
              <span class="material-symbols-outlined text-sm">delete</span>
              Delete Selected Role
            </button>
          </div>
        }
      }
    </div>
  }

  <!-- Delete Role Modal -->
  <cos-modal [isOpen]="showDeleteModal()" (closed)="closeDeleteRoleModal()" size="sm">
    <h3 class="font-bold text-lg mb-4">Delete Role</h3>
    <p>Are you sure you want to delete the selected role?</p>
    <p class="text-sm text-base-content/60 mt-2">
      This will remove all permission assignments and delegation rules for this role.
      Built-in roles (user, admin) cannot be deleted.
    </p>

    <div class="cos-modal-action">
      <button class="btn" (click)="closeDeleteRoleModal()" [disabled]="deleteLoading()">Cancel</button>
      <button class="btn btn-error" (click)="submitDeleteRole()" [disabled]="deleteLoading()">
        @if (deleteLoading()) {
          <span class="loading loading-spinner loading-sm"></span>
          Deleting...
        } @else {
          Delete Role
        }
      </button>
    </div>
  </cos-modal>

  <!-- Create Role Modal -->
  <cos-modal [isOpen]="showCreateModal()" (closed)="closeCreateRoleModal()" size="sm">
    <h3 class="font-bold text-lg mb-4">Create New Role</h3>

    <!-- Error Alert -->
    @if (createError()) {
      <div class="alert alert-error mb-4">
        <span>{{ createError() }}</span>
      </div>
    }

    <!-- Form -->
    <div class="mb-4">
      <label class="label" for="role-name">
        <span class="font-semibold">Role Name *</span>
      </label>
      <input
        id="role-name"
        type="text"
        class="input input-bordered w-full"
        placeholder="e.g., editor, moderator, viewer"
        [ngModel]="newRoleName()"
        (ngModelChange)="newRoleName.set($event)"
        [disabled]="createLoading()" />
      <div class="text-warning text-sm mt-1">
        Must match exactly with your Keycloak role configuration
      </div>
    </div>

    <div class="mb-6">
      <label class="label" for="role-description">
        <span class="font-semibold">Description</span>
      </label>
      <textarea
        id="role-description"
        class="textarea textarea-bordered w-full"
        placeholder="Optional description of this role's purpose"
        rows="3"
        [ngModel]="newRoleDescription()"
        (ngModelChange)="newRoleDescription.set($event)"
        [disabled]="createLoading()"></textarea>
    </div>

    <!-- Actions -->
    <div class="cos-modal-action">
      <button
        class="btn"
        (click)="closeCreateRoleModal()"
        [disabled]="createLoading()">
        Cancel
      </button>
      <button
        class="btn btn-primary"
        (click)="submitCreateRole()"
        [disabled]="createLoading()">
        @if (createLoading()) {
          <span class="loading loading-spinner loading-sm"></span>
          Creating...
        } @else {
          Create Role
        }
      </button>
    </div>
  </cos-modal>
</div>
