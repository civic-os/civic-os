<div class="container mx-auto p-6">
  <!-- Header -->
  <div class="flex items-center gap-4 mb-6">
    <button class="btn btn-ghost btn-circle" routerLink="/system/functions" type="button">
      <span class="material-symbols-outlined">arrow_back</span>
    </button>
    <div>
      <h1 class="text-2xl font-bold mb-0">Entity Source Code</h1>
      @if (tableName()) {
        <p class="text-sm text-base-content/60 font-mono">{{ tableName() }}</p>
      }
    </div>
  </div>

  @if (error()) {
    <div class="alert alert-error mb-4">
      <span class="material-symbols-outlined">error</span>
      <span>{{ error() }}</span>
    </div>
  }

  @if (loading()) {
    <div class="flex items-center justify-center h-64">
      <span class="loading loading-spinner loading-lg"></span>
    </div>
  }

  @if (!loading() && !error() && response()) {
    <!-- Hidden count notice -->
    @if (hiddenCount() > 0) {
      <div class="alert alert-info mb-4">
        <span class="material-symbols-outlined">visibility_off</span>
        <span>{{ hiddenCount() }} code {{ hiddenCount() === 1 ? 'item is' : 'items are' }} hidden based on your permissions.</span>
      </div>
    }

    <!-- No code objects -->
    @if (sections().length === 0 && hiddenCount() === 0) {
      <div class="text-center py-12 text-base-content/50">
        <span class="material-symbols-outlined text-4xl mb-2">code_off</span>
        <p>No executable code found for this entity.</p>
      </div>
    }

    <!-- Code sections -->
    @for (section of sections(); track section.objectType) {
      <div class="mb-8">
        <h2 class="text-lg font-semibold flex items-center gap-2 mb-3">
          <span class="material-symbols-outlined text-base-content/70">{{ section.icon }}</span>
          {{ section.title }}
          <span class="badge badge-sm badge-ghost">{{ section.items.length }}</span>
        </h2>

        <div class="space-y-4">
          @for (item of section.items; track item.object_name) {
            <div class="border border-base-300 rounded-lg p-4">
              <div class="flex items-center justify-between mb-2">
                <div>
                  <span class="font-mono font-semibold text-sm">{{ item.display_name || item.object_name }}</span>
                  @if (item.language && item.language !== 'sql') {
                    <span class="badge badge-sm badge-outline ml-2">{{ item.language }}</span>
                  }
                </div>
                @if (item.description) {
                  <span class="text-xs text-base-content/50">{{ item.description }}</span>
                }
              </div>
              <app-code-viewer
                [sourceCode]="item.source_code"
                [title]="item.object_name"
                [objectType]="item.object_type"
                [astJson]="item.ast_json"
                [functionName]="item.object_name"
                [returnType]="''" />
            </div>
          }
        </div>
      </div>
    }
  }
</div>
