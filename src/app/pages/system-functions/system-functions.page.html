<div class="container mx-auto p-6">
  <h1 class="text-2xl font-bold mb-6">Functions & RPCs</h1>

  @if (error()) {
    <div class="alert alert-error mb-4">
      <span class="material-symbols-outlined">error</span>
      <span>{{ error() }}</span>
    </div>
  }

  @if (loading()) {
    <div class="flex items-center justify-center h-64">
      <span class="loading loading-spinner loading-lg"></span>
    </div>
  }

  @if (!loading() && !error()) {
    <!-- Filters -->
    <div class="flex flex-wrap gap-3 mb-4">
      <input type="text"
             class="input input-bordered input-sm w-64"
             placeholder="Search functions..."
             [ngModel]="searchQuery()"
             (ngModelChange)="searchQuery.set($event)" />

      @if (categories().length > 0) {
        <select class="select select-bordered select-sm"
                [ngModel]="categoryFilter()"
                (ngModelChange)="categoryFilter.set($event)">
          <option value="">All Categories</option>
          @for (cat of categories(); track cat) {
            <option [value]="cat">{{ cat }}</option>
          }
        </select>
      }

      <span class="text-sm text-base-content/60 self-center">
        {{ filteredFunctions().length }} of {{ functions().length }} functions
      </span>
    </div>

    <!-- Function list -->
    @if (filteredFunctions().length === 0) {
      <div class="text-center py-12 text-base-content/50">
        <span class="material-symbols-outlined text-4xl mb-2">search_off</span>
        <p>No functions match your search.</p>
      </div>
    } @else {
      <div class="space-y-2">
        @for (fn of filteredFunctions(); track fn.function_name) {
          <div class="collapse collapse-arrow border border-base-300 bg-base-100 rounded-lg"
               [class.collapse-open]="isExpanded(fn.function_name)">
            <div class="collapse-title cursor-pointer flex items-center gap-3 pr-12"
                 (click)="toggleFunction(fn.function_name)">
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2">
                  <span class="font-mono font-semibold text-sm">{{ fn.display_name || fn.function_name }}</span>
                  @if (fn.category) {
                    <span class="badge badge-sm badge-ghost">{{ fn.category }}</span>
                  }
                  @if (fn.language) {
                    <span class="badge badge-sm badge-outline">{{ fn.language }}</span>
                  }
                  @if (fn.can_execute) {
                    <span class="badge badge-sm badge-success badge-outline">executable</span>
                  }
                </div>
                @if (fn.description) {
                  <p class="text-xs text-base-content/60 mt-1 truncate">{{ fn.description }}</p>
                }
              </div>
              <div class="flex items-center gap-2 flex-shrink-0">
                @if (fn.returns_type) {
                  <span class="text-xs text-base-content/50 font-mono">â†’ {{ fn.returns_type }}</span>
                }
                @if (fn.entity_effects && fn.entity_effects.length > 0) {
                  <span class="badge badge-sm badge-info">{{ fn.entity_effects.length }} effects</span>
                }
                @if (fn.hidden_effects_count > 0) {
                  <span class="badge badge-sm badge-warning">{{ fn.hidden_effects_count }} hidden</span>
                }
              </div>
            </div>
            <div class="collapse-content">
              @if (isExpanded(fn.function_name)) {
                <!-- Entity Effects -->
                @if (fn.entity_effects && fn.entity_effects.length > 0) {
                  <div class="mb-3">
                    <h4 class="text-xs font-semibold text-base-content/70 mb-1">Entity Effects</h4>
                    <div class="flex flex-wrap gap-1">
                      @for (effect of fn.entity_effects; track effect.table + effect.effect) {
                        <span class="badge badge-sm">
                          {{ effect.effect }} {{ effect.table }}
                          @if (effect.auto_detected) {
                            <span class="text-base-content/40 ml-1">(auto)</span>
                          }
                        </span>
                      }
                    </div>
                  </div>
                }

                <!-- Source Code -->
                @if (fn.source_code) {
                  <app-code-viewer
                    [sourceCode]="fn.source_code"
                    [title]="fn.function_name"
                    [objectType]="'function'"
                    [astJson]="fn.ast_json"
                    [functionName]="fn.function_name"
                    [returnType]="fn.returns_type" />
                } @else {
                  <div class="text-sm text-base-content/50 italic py-4">
                    Source code not available for this function.
                  </div>
                }
              }
            </div>
          </div>
        }
      </div>
    }
  }
</div>
