@if (entity$ | async; as entity) {
  <div class="prose">
    <h1>
      {{ entity.display_name }} List
      @if (entity.description) {
        <div class="tooltip tooltip-right inline-block" [attr.data-tip]="entity.description">
          <span class="material-symbols-outlined text-info cursor-help ml-2 text-2xl align-middle">help_outline</span>
        </div>
      }
    </h1>

  <!-- Sticky controls wrapper -->
  <div class="sticky-controls-wrapper">
    <!-- Search bar, Filter button, and Add button -->
    <div class="flex gap-2 items-start mb-2">
        @if (entity.search_fields && entity.search_fields.length > 0) {
          <div class="form-control flex-1">
            <label class="input input-bordered flex items-center gap-2">
              <span class="material-symbols-outlined text-base-content/50">search</span>
              <input
                type="text"
                [formControl]="searchControl"
                placeholder="Search {{ entity.display_name }}..."
                class="grow" />
              @if (searchControl.value && isLoading()) {
                <span class="loading loading-spinner loading-sm"></span>
              } @else if (searchControl.value && !isLoading()) {
                <button class="btn btn-ghost btn-xs btn-circle" (click)="clearSearch()" type="button">
                  <span class="material-symbols-outlined text-base">close</span>
                </button>
              }
            </label>
          </div>
        }

        <!-- Filter Bar -->
        @if (filterProperties$ | async; as filterProps) {
          @if (filterProps.length > 0) {
            <app-filter-bar
              [properties]="filterProps"
              [entityKey]="entityKey"
              [currentFilters]="filtersSignal()"
              (filtersChange)="onFiltersChange($event)">
            </app-filter-bar>
          }
        }

        <!-- Add Button -->
        @if (entity.insert) {
          <button class="btn btn-primary" [routerLink]="'/create/' + entityKey">
            <span class="material-symbols-outlined">add_circle</span>
            <span class="hidden sm:inline">Add {{ entity.display_name }}</span>
          </button>
        }
      </div>

      <!-- Filter Chips -->
      @if (filterChips$ | async; as chips) {
        @if (chips.length > 0) {
          <div class="text-sm not-prose mb-2 flex items-center gap-2 justify-end">
            <span class="text-base-content/60">Active filters:</span>
            @for (chip of chips; track chip.column) {
              <div class="badge badge-md gap-1 border border-primary bg-primary/10">
                <span>{{ chip.columnLabel }} ({{ chip.displayValue }})</span>
                <button class="btn btn-ghost btn-xs btn-circle hover:bg-primary/20 -mr-1" (click)="removeFilter(chip.column)" type="button">
                  <span class="material-symbols-outlined text-sm">close</span>
                </button>
              </div>
            }
          </div>
        }
      }
  </div>

  <!-- Pagination controls (top) -->
  <div class="not-prose mb-4">
      <app-pagination
        [currentPage]="currentPage()"
        [pageSize]="pageSize()"
        [totalCount]="totalCount()"
        [loading]="isLoading()"
        (pageChange)="onPageChange($event)"
        (pageSizeChange)="onPageSizeChange($event)">
      </app-pagination>
    </div>

    <!-- Grid container for table and map -->
    <div class="list-content-grid" [class.with-map]="showMap()">
      <div class="overflow-x-auto">
        <table class="table table-zebra">
        @if (displayProperties$ | async; as props) {
          <!-- head -->
          <thead>
            <tr>
              @for (prop of props; track prop) {
                <th
                  [class.sortable]="prop.sortable !== false"
                  (click)="onHeaderClick(prop)">
                  <span class="header-content">
                    {{ prop.display_name }}
                    @if (sortStateSignal().column === prop.column_name && sortStateSignal().direction === 'asc') {
                      <span class="material-symbols-outlined sort-icon sort-icon-flipped">sort</span>
                    } @else if (sortStateSignal().column === prop.column_name && sortStateSignal().direction === 'desc') {
                      <span class="material-symbols-outlined sort-icon">sort</span>
                    }
                    @if (isColumnFiltered(prop.column_name)) {
                      <span class="material-symbols-outlined text-base-content/50 text-sm ml-1">filter_alt</span>
                    }
                  </span>
                </th>
              }
            </tr>
          </thead>
          <tbody>
            @if (dataSignal(); as data) {
              @if (data?.length) {
                @for (row of data; track row) {
                  <tr
                    [routerLink]="'/view/'+entityKey+'/'+row.id"
                    class="pointer"
                    [class.highlighted-row]="showMap() && highlightedRecordId() === row.id"
                    [attr.data-record-id]="row.id"
                    (mouseenter)="onRowHover(row.id)"
                    (mouseleave)="onRowHover(null)">
                    @for (prop of props; track prop) {
                      <td>
                        <app-display-property
                          [datum]="row[prop.column_name]"
                          [property]="prop"
                          [linkRelated]="false"
                          [showLabel]="false"
                          [highlightTerms]="searchTerms()"></app-display-property>
                      </td>
                    }
                  </tr>
                }
              } @else {
                <tr>
                  <td colspan="100%" class="text-center border-spacing-4">No Entries</td>
                </tr>
              }
            }
          </tbody>
        }
      </table>
    </div>

    <!-- Map View (only shown when enabled) -->
    @if (showMap()) {
      <div class="map-container">
        <app-geo-point-map
          [markers]="mapMarkers()"
          [highlightedMarkerId]="highlightedRecordId()"
          [width]="'100%'"
          [height]="'600px'"
          (markerClick)="onMarkerClick($event)"
          (resetView)="onResetView()">
        </app-geo-point-map>
      </div>
    }
  </div>

  <!-- Pagination controls (bottom) -->
  <div class="not-prose mt-6">
    <app-pagination
      [currentPage]="currentPage()"
      [pageSize]="pageSize()"
      [totalCount]="totalCount()"
      [loading]="isLoading()"
      (pageChange)="onPageChange($event)"
      (pageSizeChange)="onPageSizeChange($event)">
    </app-pagination>
  </div>
  </div>
}
