@if (entity$ | async; as entity) {
  <div class="prose">
    <h1>
      {{ entity.display_name }} List
      @if (entity.description) {
        <div class="tooltip tooltip-right inline-block" [attr.data-tip]="entity.description">
          <span class="material-symbols-outlined text-info cursor-help ml-2 text-2xl align-middle">help_outline</span>
        </div>
      }
    </h1>

  <!-- Sticky controls wrapper -->
  <div class="sticky-controls-wrapper">
    <!-- Search bar, Filter button, and Add button -->
    <div class="flex gap-2 items-start mb-2">
        @if (entity.search_fields && entity.search_fields.length > 0) {
          <div class="form-control flex-1">
            <label class="input input-bordered flex items-center gap-2">
              <span class="material-symbols-outlined text-base-content/50" aria-hidden="true">search</span>
              <input
                type="text"
                [formControl]="searchControl"
                placeholder="Search {{ entity.display_name }}..."
                class="grow"
                [attr.aria-label]="'Search ' + entity.display_name" />
              @if (searchControl.value && isLoading()) {
                <span class="loading loading-spinner loading-sm" role="status" aria-label="Searching"></span>
              } @else if (searchControl.value && !isLoading()) {
                <button class="btn btn-ghost btn-xs btn-circle" (click)="clearSearch()" type="button" aria-label="Clear search">
                  <span class="material-symbols-outlined text-base" aria-hidden="true">close</span>
                </button>
              }
            </label>
          </div>
        } @else {
          <!-- Spacer to push buttons to the right when no search bar -->
          <div class="flex-1"></div>
        }

        <!-- Filter Bar -->
        @if (filterProperties$ | async; as filterProps) {
          @if (filterProps.length > 0) {
            <app-filter-bar
              [properties]="filterProps"
              [entityKey]="entityKey"
              [currentFilters]="filtersSignal()"
              (filtersChange)="onFiltersChange($event)">
            </app-filter-bar>
          }
        }

        <!-- Import/Export Buttons -->
        <app-import-export-buttons
          [entity]="entity"
          [entityKey]="entityKey"
          [currentFilters]="filtersSignal()"
          [searchQuery]="searchControl.value || undefined"
          [sortColumn]="sortStateSignal().column || undefined"
          [sortDirection]="sortStateSignal().direction || undefined"
          (importComplete)="onImportComplete($event)">
        </app-import-export-buttons>

        <!-- Add Button -->
        @if (entity.insert) {
          <button class="btn btn-primary btn-sm" [routerLink]="'/create/' + entityKey" [attr.aria-label]="'Add new ' + entity.display_name">
            <span class="material-symbols-outlined" aria-hidden="true">add_circle</span>
            <span class="hidden sm:inline">Add {{ entity.display_name }}</span>
          </button>
        }
      </div>

      <!-- Filter Chips -->
      @if (filterChips$ | async; as chips) {
        @if (chips.length > 0) {
          <div class="text-sm not-prose mb-2 flex items-center gap-2 justify-end">
            <span class="text-base-content/60">Active filters:</span>
            @for (chip of chips; track chip.column) {
              <div class="badge badge-md gap-1 border border-primary bg-primary/10">
                <span>{{ chip.columnLabel }} ({{ chip.displayValue }})</span>
                <button class="btn btn-ghost btn-xs btn-circle hover:bg-primary/20 -mr-1" (click)="removeFilter(chip.column)" type="button" [attr.aria-label]="'Remove filter: ' + chip.columnLabel">
                  <span class="material-symbols-outlined text-sm" aria-hidden="true">close</span>
                </button>
              </div>
            }
          </div>
        }
      }
  </div>

  <!-- Pagination controls (top) -->
  <div class="not-prose mb-4">
      <app-pagination
        [currentPage]="currentPage()"
        [pageSize]="pageSize()"
        [totalCount]="totalCount()"
        [loading]="isLoading()"
        (pageChange)="onPageChange($event)"
        (pageSizeChange)="onPageSizeChange($event)">
      </app-pagination>
    </div>

    <!-- Calendar View (only shown when enabled) -->
    @if (showCalendar()) {
      <div class="calendar-container mb-4">
        <app-time-slot-calendar
          mode="list"
          [events]="calendarEvents()"
          [loading]="isLoading()"
          [initialView]="(calendarState$ | async)?.view || 'timeGridWeek'"
          [initialDate]="(calendarState$ | async)?.date"
          (eventClick)="onCalendarEventClick($event)"
          (dateRangeChange)="onCalendarDateRangeChange($event)">
        </app-time-slot-calendar>
      </div>
    }

    <!-- Grid container for table and map -->
    <div class="list-content-grid" [class.with-map]="showMap()">
      <div class="overflow-x-auto">
        <table class="table table-zebra">
        @if (displayProperties$ | async; as props) {
          <caption class="sr-only">{{ entity.display_name }} List</caption>
          <!-- head -->
          <thead>
            <tr>
              @for (prop of props; track prop) {
                <th
                  scope="col"
                  [class.sortable]="prop.sortable !== false"
                  (click)="onHeaderClick(prop)"
                  [attr.aria-sort]="
                    sortStateSignal().column === prop.column_name
                      ? (sortStateSignal().direction === 'asc' ? 'ascending' : 'descending')
                      : (prop.sortable !== false ? 'none' : null)
                  ">
                  <span class="header-content">
                    {{ prop.display_name }}
                    @if (sortStateSignal().column === prop.column_name && sortStateSignal().direction === 'asc') {
                      <span class="material-symbols-outlined sort-icon sort-icon-flipped" aria-hidden="true">sort</span>
                    } @else if (sortStateSignal().column === prop.column_name && sortStateSignal().direction === 'desc') {
                      <span class="material-symbols-outlined sort-icon" aria-hidden="true">sort</span>
                    }
                    @if (isColumnFiltered(prop.column_name)) {
                      <span class="material-symbols-outlined text-base-content/50 text-sm ml-1" aria-hidden="true">filter_alt</span>
                    }
                  </span>
                </th>
              }
            </tr>
          </thead>
          <tbody>
            @if (dataSignal(); as data) {
              @if (data?.length) {
                @for (row of data; track row) {
                  <tr
                    [routerLink]="'/view/'+entityKey+'/'+row.id"
                    class="pointer"
                    [class.highlighted-row]="showMap() && highlightedRecordId() === row.id"
                    [attr.data-record-id]="row.id"
                    (mouseenter)="onRowHover(row.id)"
                    (mouseleave)="onRowHover(null)"
                    tabindex="0"
                    role="link"
                    [attr.aria-label]="'View details for ' + entity.display_name"
                    (keydown.enter)="onRowKeyPress($any($event), row.id)"
                    (keydown.space)="onRowKeyPress($any($event), row.id)">
                    @for (prop of props; track prop) {
                      <td>
                        <app-display-property
                          [datum]="row[prop.column_name]"
                          [property]="prop"
                          [linkRelated]="false"
                          [showLabel]="false"
                          [highlightTerms]="searchTerms()"></app-display-property>
                      </td>
                    }
                  </tr>
                }
              } @else {
                <tr>
                  <td colspan="100%" class="p-8">
                    @if (isLoading()) {
                      <!-- Loading state - show spinner while data is being fetched -->
                      <div class="flex flex-col items-center justify-center gap-4 py-12">
                        <span class="loading loading-spinner loading-lg"></span>
                        <p class="text-base-content/60">Loading records...</p>
                      </div>
                    } @else if (!entity.select && !auth.authenticated()) {
                      <app-empty-state
                        icon="lock"
                        title="Sign in to view data"
                        message="Log in to access this information."
                        alertType="info"
                        [showLoginButton]="true">
                      </app-empty-state>
                    } @else if (!entity.select) {
                      <app-empty-state
                        icon="block"
                        title="Access denied"
                        message="You don't have permission to view this data."
                        alertType="error">
                      </app-empty-state>
                    } @else if (isFiltered()) {
                      <app-empty-state
                        icon="filter_alt_off"
                        title="No results found"
                        message="No records match your current filters or search. Try adjusting or clearing them."
                        alertType="warning"
                        [showClearFiltersButton]="true"
                        (clearFilters)="onClearAllFilters()">
                      </app-empty-state>
                    } @else {
                      <app-empty-state
                        icon="inbox"
                        title="No entries"
                        message="There are no records in this table yet."
                        alertType="info">
                      </app-empty-state>
                    }
                  </td>
                </tr>
              }
            }
          </tbody>
        }
      </table>
    </div>

    <!-- Map View (only shown when enabled) -->
    @if (showMap()) {
      <div class="map-container">
        <app-geo-point-map
          [markers]="mapMarkers()"
          [highlightedMarkerId]="highlightedRecordId()"
          [width]="'100%'"
          [height]="'600px'"
          (markerClick)="onMarkerClick($event)"
          (resetView)="onResetView()">
        </app-geo-point-map>
      </div>
    }
  </div>

  <!-- Pagination controls (bottom) -->
  <div class="not-prose mt-6">
    <app-pagination
      [currentPage]="currentPage()"
      [pageSize]="pageSize()"
      [totalCount]="totalCount()"
      [loading]="isLoading()"
      (pageChange)="onPageChange($event)"
      (pageSizeChange)="onPageSizeChange($event)">
    </app-pagination>
  </div>
  </div>
}
