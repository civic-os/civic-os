<div class="prose">
  @if (entity$ | async; as entity) {
    <h1>
      {{ entity.display_name }} List: {{ resultCount() }} {{ resultCount() === 1 ? 'result' : 'results' }} @if (isFiltered()) { <span class="text-base-content/60">(filtered)</span> }
      @if (entity.description) {
        <div class="tooltip tooltip-right inline-block" [attr.data-tip]="entity.description">
          <span class="material-symbols-outlined text-info cursor-help ml-2 text-2xl align-middle">help_outline</span>
        </div>
      }
    </h1>

    <!-- Search bar and Filter button -->
    <div class="flex gap-2 items-start mb-4 not-prose" [class.justify-end]="!(entity.search_fields && entity.search_fields.length > 0)" [class.justify-between]="entity.search_fields && entity.search_fields.length > 0">
      @if (entity.search_fields && entity.search_fields.length > 0) {
        <div class="form-control flex-1">
          <label class="input input-bordered flex items-center gap-2">
            <span class="material-symbols-outlined text-base-content/50">search</span>
            <input
              type="text"
              [formControl]="searchControl"
              placeholder="Search {{ entity.display_name }}..."
              class="grow" />
            @if (searchControl.value && isLoading()) {
              <span class="loading loading-spinner loading-sm"></span>
            } @else if (searchControl.value && !isLoading()) {
              <button class="btn btn-ghost btn-xs btn-circle" (click)="clearSearch()" type="button">
                <span class="material-symbols-outlined text-base">close</span>
              </button>
            }
          </label>
        </div>
      }

      <!-- Filter Bar -->
      @if (filterProperties$ | async; as filterProps) {
        @if (filterProps.length > 0) {
          <app-filter-bar
            [properties]="filterProps"
            [entityKey]="entityKey"
            [currentFilters]="filtersSignal()"
            (filtersChange)="onFiltersChange($event)">
          </app-filter-bar>
        }
      }
    </div>

    <!-- Filter Chips -->
    @if (filterChips$ | async; as chips) {
      @if (chips.length > 0) {
        <div class="flex flex-wrap gap-2 mb-4 not-prose justify-end">
          @for (chip of chips; track chip.column) {
            <div class="badge badge-lg gap-2 border-2 border-primary bg-primary/10 font-medium">
              <span>{{ chip.columnLabel }}: {{ chip.displayValue }}</span>
              <button class="btn btn-ghost btn-xs btn-circle hover:bg-primary/20" (click)="removeFilter(chip.column)" type="button">
                <span class="material-symbols-outlined text-base font-bold">close</span>
              </button>
            </div>
          }
        </div>
      }
    }

    <div class="overflow-x-auto">
      @if (entity.insert) {
        <button class="btn btn-primary" [routerLink]="'/create/' + entityKey">
          <span class="material-symbols-outlined">add_circle</span> Add {{ entity.display_name }}
        </button>
      }
      <table class="table table-zebra table-pin-rows">
        @if (properties$ | async; as props) {
          <!-- head -->
          <thead>
            <tr>
              @for (prop of props; track prop) {
                <th
                  [class.sortable]="prop.sortable !== false"
                  (click)="onHeaderClick(prop)">
                  <span class="header-content">
                    {{ prop.display_name }}
                    @if (sortStateSignal().column === prop.column_name && sortStateSignal().direction === 'asc') {
                      <span class="material-symbols-outlined sort-icon sort-icon-flipped">sort</span>
                    } @else if (sortStateSignal().column === prop.column_name && sortStateSignal().direction === 'desc') {
                      <span class="material-symbols-outlined sort-icon">sort</span>
                    }
                    @if (isColumnFiltered(prop.column_name)) {
                      <span class="material-symbols-outlined text-base-content/50 text-sm ml-1">filter_alt</span>
                    }
                  </span>
                </th>
              }
            </tr>
          </thead>
          @if (data$ | async; as data) {
            <tbody>
              @if (data?.length) {
                @for (row of data; track row) {
                  <tr [routerLink]="'/view/'+entityKey+'/'+row.id" class="pointer">
                    @for (prop of props; track prop) {
                      <td>
                        <app-display-property
                          [datum]="row[prop.column_name]"
                          [property]="prop"
                          [linkRelated]="false"
                          [showLabel]="false"
                          [highlightTerms]="searchTerms()"></app-display-property>
                      </td>
                    }
                  </tr>
                }
              } @else {
                <tr>
                  <td colspan="100%" class="text-center border-spacing-4">No Entries</td>
                </tr>
              }
            </tbody>
          }
        }
      </table>
    </div>
  }
</div>
