<div class="prose">
  @if (entity$ | async; as entity) {
    @if (properties$ | async; as props) {
      @if (data$ | async; as data) {
        <div class="flex items-center gap-4 mb-4">
          <button class="btn btn-ghost btn-circle" [routerLink]="'/view/' + entity.table_name + '/' + entityId" type="button">
            <span class="material-symbols-outlined">arrow_back</span>
          </button>
          <h1 class="mb-0">
            {{ entity.display_name }}: {{ data.display_name }} <sub>(Id: {{entityId}})</sub>
            @if (entity.description) {
              <div class="tooltip tooltip-right inline-block" [attr.data-tip]="entity.description">
                <span class="material-symbols-outlined text-info cursor-help ml-2 text-xl align-middle">help_outline</span>
              </div>
            }
          </h1>
          @if (seriesMembership()?.is_member) {
            <a class="badge badge-info gap-1 cursor-pointer" [routerLink]="['/admin/recurring-schedules', seriesMembership()?.group_id]">
              <span class="material-symbols-outlined text-sm">repeat</span>
              {{ seriesMembership()?.group_name || 'Recurring' }}
            </a>
          }
        </div>
        @if (loading()) {
          <div class="flex justify-center my-8">
            <span class="loading loading-spinner loading-lg"></span>
          </div>
        } @else if (entity.update && editForm; as form) {
          <form [formGroup]="form" (ngSubmit)="submitForm($event)">
            @if (showValidationError()) {
              <div role="alert" class="alert alert-error mb-4">
                <span class="material-symbols-outlined">error</span>
                <span>Please fix the errors highlighted below before saving.</span>
              </div>
            }
            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 2xl:grid-cols-8 gap-6">
              @if (editRenderables$ | async; as renderables) {
                @for (item of renderables; track item.itemType === 'static_text' ? 'st_' + item.id : item.column_name) {
                  @if (isStaticText(item)) {
                    <div [class]="'col-span-full sm:col-span-' + Math.min(SchemaService.getRenderableColumnSpan(item), 3) + ' lg:col-span-' + Math.min(SchemaService.getRenderableColumnSpan(item), 6) + ' 2xl:col-span-' + SchemaService.getRenderableColumnSpan(item)">
                      <app-static-text [staticText]="item"></app-static-text>
                    </div>
                  } @else if (isProperty(item)) {
                    <div [class]="'col-span-full sm:col-span-' + Math.min(SchemaService.getRenderableColumnSpan(item), 3) + ' lg:col-span-' + Math.min(SchemaService.getRenderableColumnSpan(item), 6) + ' 2xl:col-span-' + SchemaService.getRenderableColumnSpan(item)">
                      <app-edit-property [property]="item" [formGroup]="form" [entityType]="entityKey!" [entityId]="entityId!"></app-edit-property>
                    </div>
                  }
                }
              }
            </div>
            <div class="divider"></div>
            <button type="submit" class="btn btn-accent">
              <span class="material-symbols-outlined">save</span> Save
            </button>
          </form>
        } @else if (!entity.update) {
          <!-- Access denied when record exists but user lacks update permission -->
          <div class="p-8">
            @if (!auth.authenticated()) {
              <app-empty-state
                icon="lock"
                title="Sign in to edit records"
                message="Log in to access this feature."
                alertType="info"
                [showLoginButton]="true">
              </app-empty-state>
            } @else {
              <app-empty-state
                icon="block"
                title="Access denied"
                message="You don't have permission to edit records of this type."
                alertType="error">
              </app-empty-state>
            }
          </div>
        }
      } @else {
        <!-- Loading or error state when data is not available -->
        <div class="p-8">
          @if (dataLoading()) {
            <!-- Loading state -->
            <div class="flex flex-col items-center justify-center gap-4 py-12">
              <span class="loading loading-spinner loading-lg"></span>
              <p class="text-base-content/60">Loading record...</p>
            </div>
          } @else if (!entity.update) {
            @if (!auth.authenticated()) {
              <app-empty-state
                icon="lock"
                title="Sign in to edit records"
                message="Log in to access this feature."
                alertType="info"
                [showLoginButton]="true">
              </app-empty-state>
            } @else {
              <app-empty-state
                icon="block"
                title="Access denied"
                message="You don't have permission to edit records of this type."
                alertType="error">
              </app-empty-state>
            }
          } @else {
            <app-empty-state
              icon="error"
              title="Record not found"
              message="The record you're looking for doesn't exist."
              alertType="error">
            </app-empty-state>
          }
        </div>
      }
    }
    <app-dialog #successDialog>
      <div class="flex flex-col gap-2 w-full">
        <button class="btn whitespace-normal h-auto min-h-12" (click)="navToList(entity.table_name)">Back to {{entity.display_name}} list</button>
        <button class="btn whitespace-normal h-auto min-h-12" (click)="navToRecord(entity.table_name, entityId)">Back to record</button>
      </div>
    </app-dialog>
    <app-dialog #errorDialog>
      <div class="flex flex-col gap-2 w-full">
        <button class="btn whitespace-normal h-auto min-h-12">Try again</button>
        <button class="btn whitespace-normal h-auto min-h-12" (click)="navToList(entity.table_name)">Back to {{entity.display_name}} list</button>
      </div>
    </app-dialog>

    <!-- Series Scope Dialog -->
    <app-exception-editor
      [isOpen]="showScopeDialog()"
      [membership]="seriesMembership()"
      [operation]="'edit'"
      (confirm)="onScopeConfirm($event)"
      (cancel)="onScopeCancel()"
    ></app-exception-editor>
  }
</div>
