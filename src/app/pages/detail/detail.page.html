<div class="prose">
  @if (entity$ | async; as entity) {
    @if (regularProps$ | async; as regularProps) {
      @if (data$ | async; as data) {
        <div class="flex items-center gap-4 mb-4 mt-4">
          <button class="btn btn-ghost btn-circle" [routerLink]="'/view/' + entity.table_name" type="button">
            <span class="material-symbols-outlined">arrow_back</span>
          </button>
          <h1 class="mb-0 flex-1">{{ entity.display_name }}: {{ data.display_name }}
            <span class="ml-8 inline-flex gap-2">
              @if (entity.update) {
                <button class="btn btn-accent" [routerLink]="'/edit/' + entityKey + '/' + data.id">
                  <span class="material-symbols-outlined">edit</span> Edit
                </button>
              }
              @if (entity.delete) {
                <button class="btn btn-error" (click)="openDeleteModal()">
                  <span class="material-symbols-outlined">delete</span> Delete
                </button>
              }
            </span>
          </h1>
        </div>
        <h2 class="text-2xl font-bold mt-6 mb-4">Details</h2>
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 2xl:grid-cols-8 gap-6">
          @for (prop of regularProps; track prop) {
            <div [class]="'col-span-full sm:col-span-' + Math.min(SchemaService.getColumnSpan(prop), 3) + ' lg:col-span-' + Math.min(SchemaService.getColumnSpan(prop), 6) + ' 2xl:col-span-' + SchemaService.getColumnSpan(prop)">
              <app-display-property [datum]="data[prop.column_name]" [property]="prop"></app-display-property>
            </div>
          }
        </div>

        <!-- Many-to-Many Relationships Section -->
        @if (manyToManyProps$ | async; as manyToManyProps) {
          @if (manyToManyProps.length > 0) {
            <div class="card bg-base-100 shadow-xl mt-6">
              <div class="card-body">
                @for (prop of manyToManyProps; track prop.column_name) {
                  <app-many-to-many-editor
                    [entityId]="data.id"
                    [property]="prop"
                    [currentValues]="data[prop.column_name] || []"
                    (relationChanged)="refreshData()">
                  </app-many-to-many-editor>
                  @if (!$last) {
                    <div class="divider"></div>
                  }
                }
              </div>
            </div>
          }
        }

        <!-- Inverse Relationships Section -->
        @if (inverseRelationships$ | async; as relationships) {
          @if (relationships.length > 0) {
            <div class="mt-8">
              <h2 class="text-2xl font-bold mb-4">Related Records</h2>

              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                @for (relationship of relationships; track relationship.meta.sourceTable) {
                  <div class="card bg-base-200">
                    <div class="card-body">
                      <h3 class="card-title">
                        {{ relationship.meta.sourceTableDisplayName }}
                        <span class="badge badge-primary">{{ relationship.totalCount }}</span>
                      </h3>

                      <!-- Large relationship: Show only "View all" button -->
                      @if (relationship.totalCount > LARGE_RELATIONSHIP_THRESHOLD) {
                        <p class="text-sm opacity-70">This relationship has many records. Click below to view the full list.</p>
                        <div class="card-actions">
                          <a
                            [routerLink]="'/view/' + relationship.meta.sourceTable"
                            [queryParams]="{
                              f0_col: relationship.meta.sourceColumn,
                              f0_op: 'eq',
                              f0_val: data.id
                            }"
                            class="btn btn-sm btn-primary"
                          >
                            View all {{ relationship.totalCount }} records
                            <span class="material-symbols-outlined ml-1">arrow_forward</span>
                          </a>
                        </div>
                      } @else {
                        <!-- Normal relationship: Show preview in paragraph format -->
                        @if (relationship.previewRecords.length > 0) {
                          <div class="text-sm leading-relaxed">
                            @for (record of relationship.previewRecords; track record.id; let isLast = $last) {
                              <a
                                [routerLink]="'/view/' + relationship.meta.sourceTable + '/' + record.id"
                                class="link link-primary"
                              >{{ record.display_name }}</a>@if (!isLast) {<span class="mx-1">â€¢</span>}
                            }
                          </div>
                        }

                        <!-- "View all" link if count exceeds preview limit -->
                        @if (relationship.totalCount > relationship.meta.previewLimit) {
                          <div class="card-actions justify-end mt-2">
                            <a
                              [routerLink]="'/view/' + relationship.meta.sourceTable"
                              [queryParams]="{
                                f0_col: relationship.meta.sourceColumn,
                                f0_op: 'eq',
                                f0_val: data.id
                              }"
                              class="btn btn-sm btn-outline"
                            >
                              View all {{ relationship.totalCount }}
                              <span class="material-symbols-outlined ml-1">arrow_forward</span>
                            </a>
                          </div>
                        }
                      }
                    </div>
                  </div>
                }
              </div>
            </div>
          }
        }

        <!-- Delete Confirmation Modal -->
        @if (showDeleteModal()) {
          <div class="modal modal-open">
            <div class="modal-box">
              <h3 class="font-bold text-lg mb-4">Delete {{ entity.display_name }}?</h3>

              <!-- Error Alert -->
              @if (deleteError()) {
                <div class="alert alert-error mb-4">
                  <span>{{ deleteError() }}</span>
                </div>
              }

              <p class="mb-6">
                Are you sure you want to delete <strong>{{ data.display_name }}</strong>? This action cannot be undone.
              </p>

              <!-- Actions -->
              <div class="modal-action">
                <button
                  class="btn"
                  (click)="closeDeleteModal()"
                  [disabled]="deleteLoading()">
                  Cancel
                </button>
                <button
                  class="btn btn-error"
                  (click)="confirmDelete()"
                  [disabled]="deleteLoading()">
                  @if (deleteLoading()) {
                    <span class="loading loading-spinner loading-sm"></span>
                    Deleting...
                  } @else {
                    <span class="material-symbols-outlined">delete</span>
                    Delete
                  }
                </button>
              </div>
            </div>
          </div>
        }
      }
    }
  }
</div>
