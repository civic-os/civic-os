<div class="prose">
  <!-- Use ng-container to handle both entity-found and entity-not-found cases -->
  @if (entity$ | async; as entity) {
    <!-- Entity found in schema - check permissions -->
    @if (!entity.select && !auth.authenticated()) {
      <!-- User doesn't have select permission and is not logged in -->
      <div class="p-8">
        <app-empty-state
          icon="lock"
          title="Sign in to view this record"
          message="Log in to access this information."
          alertType="info"
          [showLoginButton]="true">
        </app-empty-state>
      </div>
    } @else if (!entity.select) {
      <!-- User is authenticated but doesn't have select permission -->
      <div class="p-8">
        <app-empty-state
          icon="block"
          title="Access denied"
          message="You don't have permission to view this record."
          alertType="error">
        </app-empty-state>
      </div>
    } @else {
      <!-- User has select permission - proceed with normal flow -->
      @if (regularProps$ | async; as regularProps) {
        @if (data$ | async; as data) {
          <!-- Header row (clean, just back button + title) -->
        <div class="flex items-center gap-4 mb-2 mt-4">
          <button class="btn btn-ghost btn-circle" [routerLink]="'/view/' + entity.table_name" type="button">
            <span class="material-symbols-outlined">arrow_back</span>
          </button>
          <h1 class="mb-0 flex-1">{{ entity.display_name }}: {{ data.display_name }}</h1>
          @if (seriesMembership()?.is_member) {
            <a class="badge badge-info gap-1 cursor-pointer" [routerLink]="['/admin/recurring-schedules', seriesMembership()?.group_id]">
              <span class="material-symbols-outlined text-sm">repeat</span>
              {{ seriesMembership()?.group_name || 'Recurring' }}
            </a>
          }
        </div>

        <!-- Action Bar (separate row, left-aligned) -->
        @if (actionButtons$ | async; as buttons) {
          @if (buttons.length > 0) {
            <div class="mb-4">
              <app-action-bar
                [buttons]="buttons"
                (buttonClick)="onActionButtonClick($event)">
              </app-action-bar>
            </div>
          }
        }

        <!-- Payment Error Alert -->
        @if (paymentError()) {
          <div class="alert alert-error mb-4">
            <span class="material-symbols-outlined">error</span>
            <span>{{ paymentError() }}</span>
          </div>
        }

        <!-- Action Error Alert (for non-modal actions) -->
        @if (actionError() && !showActionModal()) {
          <div class="alert alert-error mb-4">
            <span class="material-symbols-outlined">error</span>
            <span>{{ actionError() }}</span>
          </div>
        }

        <h2 class="text-2xl font-bold mt-6 mb-4">Details</h2>
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 2xl:grid-cols-8 gap-6">
          @if (detailRenderables$ | async; as renderables) {
            @for (item of renderables; track item.itemType === 'static_text' ? 'st_' + item.id : item.column_name) {
              @if (isStaticText(item)) {
                <div [class]="'col-span-full sm:col-span-' + Math.min(SchemaService.getRenderableColumnSpan(item), 3) + ' lg:col-span-' + Math.min(SchemaService.getRenderableColumnSpan(item), 6) + ' 2xl:col-span-' + SchemaService.getRenderableColumnSpan(item)">
                  <app-static-text [staticText]="item"></app-static-text>
                </div>
              } @else if (isProperty(item) && item.type !== 17) {
                <!-- Render properties (excluding ManyToMany type=17) -->
                <div [class]="'col-span-full sm:col-span-' + Math.min(SchemaService.getRenderableColumnSpan(item), 3) + ' lg:col-span-' + Math.min(SchemaService.getRenderableColumnSpan(item), 6) + ' 2xl:col-span-' + SchemaService.getRenderableColumnSpan(item)">
                  <app-display-property [datum]="data[item.column_name]" [property]="item"></app-display-property>
                </div>
              }
            }
          }
        </div>

        <!-- Many-to-Many Relationships Section -->
        @if (manyToManyProps$ | async; as manyToManyProps) {
          @if (manyToManyProps.length > 0) {
            <div class="card bg-base-100 shadow-xl mt-6">
              <div class="card-body">
                @for (prop of manyToManyProps; track prop.column_name) {
                  <app-many-to-many-editor
                    [entityId]="data.id"
                    [property]="prop"
                    [currentValues]="data[prop.column_name] || []"
                    [refreshTrigger]="refreshCounter()"
                    (relationChanged)="refreshData()">
                  </app-many-to-many-editor>
                  @if (!$last) {
                    <div class="divider"></div>
                  }
                }
              </div>
            </div>
          }
        }

        <!-- Entity Notes Section -->
        @if (entity.enable_notes) {
          <app-entity-notes
            [entityType]="entity.table_name"
            [entityId]="data.id.toString()"
            [refreshTrigger]="refreshCounter()">
          </app-entity-notes>
        }

        <!-- Inverse Relationships Section -->
        @if (inverseRelationships$ | async; as relationships) {
          @if (relationships.length > 0) {
            <div class="mt-8">
              <h2 class="text-2xl font-bold mb-4">Related Records</h2>

              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                @for (relationship of relationships; track relationship.meta.sourceTable) {
                  <div class="card bg-base-200">
                    <div class="card-body">
                      <h3 class="card-title">
                        {{ relationship.meta.sourceTableDisplayName }}
                        <span class="badge badge-primary">{{ relationship.totalCount }}</span>
                      </h3>

                      <!-- Large relationship: Show only "View all" button -->
                      @if (relationship.totalCount > LARGE_RELATIONSHIP_THRESHOLD) {
                        <p class="text-sm opacity-70">This relationship has many records. Click below to view the full list.</p>
                        <div class="card-actions">
                          <a
                            [routerLink]="'/view/' + relationship.meta.sourceTable"
                            [queryParams]="{
                              f0_col: relationship.meta.sourceColumn,
                              f0_op: 'eq',
                              f0_val: data.id
                            }"
                            class="btn btn-sm btn-primary"
                          >
                            View all {{ relationship.totalCount }} records
                            <span class="material-symbols-outlined ml-1">arrow_forward</span>
                          </a>
                        </div>
                      } @else {
                        <!-- Normal relationship: Show preview in paragraph format -->
                        @if (relationship.previewRecords.length > 0) {
                          <div class="text-sm leading-relaxed">
                            @for (record of relationship.previewRecords; track record.id; let isLast = $last) {
                              <a
                                [routerLink]="'/view/' + relationship.meta.sourceTable + '/' + record.id"
                                class="link link-primary"
                              >{{ record.display_name }}</a>@if (!isLast) {<span class="mx-1">•</span>}
                            }
                          </div>
                        }

                        <!-- "View all" link if count exceeds preview limit -->
                        @if (relationship.totalCount > relationship.meta.previewLimit) {
                          <div class="card-actions justify-end mt-2">
                            <a
                              [routerLink]="'/view/' + relationship.meta.sourceTable"
                              [queryParams]="{
                                f0_col: relationship.meta.sourceColumn,
                                f0_op: 'eq',
                                f0_val: data.id
                              }"
                              class="btn btn-sm btn-outline"
                            >
                              View all {{ relationship.totalCount }}
                              <span class="material-symbols-outlined ml-1">arrow_forward</span>
                            </a>
                          </div>
                        }
                      }
                    </div>
                  </div>
                }
              </div>
            </div>
          }
        }

        <!-- Calendar Sections - DISABLED
             TODO: This feature needs UX improvements before enabling:
             - Creates redundancy in 1:1 relationships (e.g., Reservation ← Reservation Request)
             - No way to distinguish between "show calendar on list page" vs "show in related records"
             - Consider adding separate entity metadata flag: show_calendar_in_related_records
             - Consider minimum threshold (e.g., only show if 2+ related events)
             - Consider combining with regular Related Records section instead of separate calendar
        @if (calendarSections$ | async; as calendarSections) {
          @if (calendarSections.length > 0) {
            <div class="mt-8">
              @for (section of calendarSections; track section.meta.sourceTable) {
                <div class="card bg-base-200 mb-6">
                  <div class="card-body">
                    <h3 class="card-title">
                      {{ section.meta.sourceEntityDisplayName }}
                      <span class="badge badge-primary">{{ section.events.length }}</span>
                    </h3>

                    <div class="card-actions justify-end mb-4">
                      <button
                        class="btn btn-primary btn-sm"
                        (click)="navigateToCreateRelated(section.meta.sourceTable, section.meta.sourceColumn)">
                        <span class="material-symbols-outlined">add</span>
                        Add {{ section.meta.sourceEntityDisplayName }}
                      </button>
                    </div>

                    <app-time-slot-calendar
                      mode="display"
                      [events]="section.events"
                      (eventClick)="onCalendarEventClick($event, section)"
                      (dateSelect)="onCalendarDateSelect($event, section)">
                    </app-time-slot-calendar>
                  </div>
                </div>
              }
            </div>
          }
        }
        -->

        <!-- Delete Confirmation Modal -->
        @if (showDeleteModal()) {
          <div class="modal modal-open">
            <div class="modal-box">
              <h3 class="font-bold text-lg mb-4">Delete {{ entity.display_name }}?</h3>

              <!-- Error Alert -->
              @if (deleteError()) {
                <div class="alert alert-error mb-4">
                  <span>{{ deleteError() }}</span>
                </div>
              }

              <p class="mb-6">
                Are you sure you want to delete <strong>{{ data.display_name }}</strong>? This action cannot be undone.
              </p>

              <!-- Actions -->
              <div class="modal-action">
                <button
                  class="btn"
                  (click)="closeDeleteModal()"
                  [disabled]="deleteLoading()">
                  Cancel
                </button>
                <button
                  class="btn btn-error"
                  (click)="confirmDelete()"
                  [disabled]="deleteLoading()">
                  @if (deleteLoading()) {
                    <span class="loading loading-spinner loading-sm"></span>
                    Deleting...
                  } @else {
                    <span class="material-symbols-outlined">delete</span>
                    Delete
                  }
                </button>
              </div>
            </div>
          </div>
        }

        <!-- Payment Checkout Modal -->
        @if (currentPaymentId()) {
          <app-payment-checkout
            [paymentId]="currentPaymentId()!"
            [isOpen]="showCheckoutModal()"
            (paymentSuccess)="handlePaymentSuccess($event)"
            (close)="handleCheckoutClose()">
          </app-payment-checkout>
        }

        <!-- Delete Scope Dialog (for recurring series members) -->
        <app-exception-editor
          [isOpen]="showDeleteScopeDialog()"
          [membership]="seriesMembership()"
          [operation]="'delete'"
          (confirm)="onDeleteScopeConfirm($event)"
          (cancel)="onDeleteScopeCancel()"
        ></app-exception-editor>

        <!-- Entity Action Confirmation Modal -->
        @if (showActionModal()) {
          <div class="modal modal-open">
            <div class="modal-box">
              @if (currentAction(); as action) {
                <h3 class="font-bold text-lg mb-4">{{ action.display_name }}</h3>

                <!-- Error Alert -->
                @if (actionError()) {
                  <div class="alert alert-error mb-4">
                    <span class="material-symbols-outlined">error</span>
                    <span>{{ actionError() }}</span>
                  </div>
                }

                <!-- Success Alert -->
                @if (actionSuccess()) {
                  <div class="alert alert-success mb-4">
                    <span class="material-symbols-outlined">check_circle</span>
                    <span>{{ actionSuccess() }}</span>
                  </div>
                } @else {
                  <p class="mb-6">{{ action.confirmation_message || 'Are you sure you want to proceed?' }}</p>

                  <!-- Actions -->
                  <div class="modal-action">
                    <button
                      class="btn"
                      (click)="closeActionModal()"
                      [disabled]="actionLoading()">
                      Cancel
                    </button>
                    <button
                      [class]="'btn btn-' + action.button_style"
                      (click)="confirmEntityAction()"
                      [disabled]="actionLoading()">
                      @if (actionLoading()) {
                        <span class="loading loading-spinner loading-sm"></span>
                      }
                      Confirm
                    </button>
                  </div>
                }
              }
            </div>
            <div class="modal-backdrop bg-base-300/50" (click)="closeActionModal()"></div>
          </div>
        }

        <!-- Action Loading Overlay (for non-confirmation actions) -->
        @if (actionOverlayLoading()) {
          <div class="fixed inset-0 bg-base-100/50 flex items-center justify-center z-50">
            <div class="flex flex-col items-center gap-2">
              <span class="loading loading-spinner loading-lg"></span>
              <span class="text-sm opacity-70">Processing...</span>
            </div>
          </div>
        }
      } @else {
        <!-- Loading or error state when data is not available -->
        <!-- Permission checks are handled in the outer block, so we only show loading/not-found here -->
        <div class="p-8">
          @if (dataLoading()) {
            <!-- Loading state -->
            <div class="flex flex-col items-center justify-center gap-4 py-12">
              <span class="loading loading-spinner loading-lg"></span>
              <p class="text-base-content/60">Loading record...</p>
            </div>
          } @else {
            <!-- Data fetch completed but no data returned - record doesn't exist -->
            <app-empty-state
              icon="error"
              title="Record not found"
              message="The record you're looking for doesn't exist."
              alertType="error">
            </app-empty-state>
          }
        </div>
      }
    }
    } <!-- Close @else { entity.select } -->
  } @else {
    <!-- Entity not found in schema_entities - likely no privileges for anonymous user -->
    <div class="p-8">
      @if (!auth.authenticated()) {
        <!-- Anonymous user - the entity might exist but they have no privileges to see it -->
        <app-empty-state
          icon="lock"
          title="Sign in to view this record"
          message="Log in to access this information."
          alertType="info"
          [showLoginButton]="true">
        </app-empty-state>
      } @else {
        <!-- Authenticated but entity truly doesn't exist or user has no access -->
        <app-empty-state
          icon="error"
          title="Record not found"
          message="The record you're looking for doesn't exist or you don't have access."
          alertType="error">
        </app-empty-state>
      }
    </div>
  }
</div>
